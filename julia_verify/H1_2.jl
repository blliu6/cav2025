include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50


SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    # Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]


#H1
# third
## Multiplier-2
P0 = 157*X[1]^2//100000 - 557*X[1]*X[2]//100000 + 2*X[1]//625 + 147*X[2]^2//10000 - 47*X[2]//6250 + 21//1000
M0 = [1, X[2], X[1]]
Q0 = [0.02082138488978886 -0.003721741530676589 0.0016132049602245702;
 -0.003721741530676589 0.015156159091958447 -0.0028743511852261615;
 0.0016132049602245702 -0.0028743511852261615 0.0019952646042398453;
]
solve(n, X, P0, Q0, M0, true)
## Total Decomposition
P1 = 199*X[1]^4//10000 - 13*X[1]^3*X[2]//1000 + 63*X[1]^3//2000 - 577*X[1]^2*X[2]^2//10000 + 467*X[1]^2*X[2]//10000 + 157*X[1]^2//2000 - 77*X[1]*X[2]^3//12500 - 193*X[1]*X[2]^2//2500 - 171*X[1]*X[2]//25000 - 37*X[1]//2500 + 18*X[2]^4//125 - 991*X[2]^3//10000 + 229*X[2]^2//1000 - 59*X[2]//2000 + 97//500
M1 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q1 = [0.19358891211512008 -0.014760278944818659 -0.007314384781299567 0.021365361974468814 0.0017903541491925618 -0.013009041970159554;
 -0.014760278944818659 0.18619605027582403 -0.005232214010342652 -0.049638613970573044 -0.0025521046961767477 0.018589806735721602;
 -0.007314384781299567 -0.005232214010342652 0.10428515207785516 -0.03591111009253306 0.004786231943821458 0.015754183618745206;
 0.021365361974468814 -0.049638613970573044 -0.03591111009253306 0.14376195232092642 -0.0030551547366199985 -0.04151461347944638;
 0.0017903541491925618 -0.0025521046961767477 0.004786231943821458 -0.0030551547366199985 0.025633053826596853 -0.006603962847555411;
 -0.013009041970159554 0.018589806735721602 0.015754183618745206 -0.04151461347944638 -0.006603962847555411 0.02017652597038843;
]
solve(n, X, P1, Q1, M1, true)
## Multiplier-1
P2 = 87*X[1]^2//20000 - 69*X[1]*X[2]//5000 + 747*X[1]//100000 + 71*X[2]^2//2000 - 143*X[2]//5000 + 37//1000
M2 = [1, X[2], X[1]]
Q2 = [0.036656180189695964 -0.014196468175784883 0.003706370227336235;
 -0.014196468175784883 0.035315321030802496 -0.006829888446373932;
 0.003706370227336235 -0.006829888446373932 0.0044094822558792025;
]
solve(n, X, P2, Q2, M2, true)
# second
## Multiplier-2
P3 = 43*X[1]^2//2500 + 17*X[1]*X[2]//10000 + 47*X[1]//25000 + 67*X[2]^2//200000 + 23*X[2]//50000 + 1//200
M3 = [1, X[2], X[1]]
Q3 = [0.004678174326459476 0.00021568350625675824 0.0008809479598739406;
 0.00021568350625675824 0.00040891771735173673 0.001035985779575402;
 0.0008809479598739406 0.001035985779575402 0.01722447496233989;
]
solve(n, X, P3, Q3, M3, true)
## Total Decomposition
P4 = 219*X[1]^4//10000 + 377*X[1]^3*X[2]//100000 + 291*X[1]^3//100000 + 871*X[1]^2*X[2]^2//100000 - 23*X[1]^2*X[2]//20000 + 101*X[1]^2//1000 + 913*X[1]*X[2]^3//1000000 + 17*X[1]*X[2]^2//10000 + 487*X[1]*X[2]//50000 + 39*X[1]//100000 + 123*X[2]^4//100000 + 3*X[2]^3//2000 + 23*X[2]^2//2500 - 39*X[2]//100000 + 49//500
M4 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q4 = [0.09820629673976422 -0.00020926094428021363 0.00015131892688217762 -0.005411904493156917 0.0005311238281440436 0.0054495331593740785;
 -0.00020926094428021363 0.02005247791381401 0.004392304117521976 0.0007450649881031986 0.000697569922752073 -0.0007403126949429116;
 0.00015131892688217762 0.004392304117521976 0.08966727029728479 0.00018949043893655516 0.00012186451227024613 0.0014806946321422854;
 -0.005411904493156917 0.0007450649881031986 0.00018949043893655516 0.0013795347483187878 0.0005311247159066328 -0.0014402045684591429;
 0.0005311238281440436 0.000697569922752073 0.00012186451227024613 0.0005311247159066328 0.011304033511401882 0.0018084602083113122;
 0.0054495331593740785 -0.0007403126949429116 0.0014806946321422854 -0.0014402045684591429 0.0018084602083113122 0.022260715772085965;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-1
P5 = 111*X[1]^2//10000 + 499*X[1]*X[2]//500000 + X[1]//800 + 57*X[2]^2//250000 + 37*X[2]//100000 + 1//250
M5 = [1, X[2], X[1]]
Q5 = [0.00392364862139177 0.0001815901255272689 0.0006100578071493733;
 0.0001815901255272689 0.0003256702241017139 0.0007080041081878138;
 0.0006100578071493733 0.0007080041081878138 0.01179281997568029;
]
solve(n, X, P5, Q5, M5, true)
# seventh
## Multiplier-2
P6 = 1//250
M6 = [1, X[2], X[1]]
Q6 = [0.0039758664312632445 5.758535568021053e-20 -3.1679974801201394e-19;
 5.758535568021053e-20 4.511981824463138e-05 -8.396205558155954e-21;
 -3.1679974801201394e-19 -8.396205558155954e-21 2.382763883958073e-05;
]
solve(n, X, P6, Q6, M6, true)
## Total Decomposition
P7 = 193*X[1]^4//10000000 + 193*X[1]^2*X[2]^2//5000000 - 23*X[1]^2//12500 + 193*X[2]^4//10000000 - 23*X[2]^2//12500 + 193//1000
M7 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q7 = [0.1933006343694421 -2.4438045137036234e-18 1.611902693236517e-18 -0.001953592894334528 3.45995847495064e-19 -0.001953592890305037;
 -2.4438045137036234e-18 0.0016605442125581437 1.3266389177389597e-18 5.797985711668618e-20 5.0987880295505936e-20 1.6235484130758055e-20;
 1.611902693236517e-18 1.3266389177389597e-18 0.0016605442141642615 -4.615800730759546e-19 2.192739152798331e-21 3.9133976359874847e-19;
 -0.001953592894334528 5.797985711668618e-20 -4.615800730759546e-19 4.511981821179785e-05 -8.395001857091243e-21 7.848573911127731e-06;
 3.45995847495064e-19 5.0987880295505936e-20 2.192739152798331e-21 -8.395001857091243e-21 3.195812954877981e-05 -8.446445088396598e-21;
 -0.001953592890305037 1.6235484130758055e-20 3.9133976359874847e-19 7.848573911127731e-06 -8.446445088396598e-21 4.511981815256872e-05;
]
solve(n, X, P7, Q7, M7, true)
## Multiplier-1
P8 = 1//250
M8 = [1, X[2], X[1]]
Q8 = [0.003975866389902032 -2.573789268619893e-20 2.9893933036312265e-19;
 -2.573789268619893e-20 2.3827638807309107e-05 -8.445241379374081e-21;
 2.9893933036312265e-19 -8.445241379374081e-21 4.511981805879047e-05;
]
solve(n, X, P8, Q8, M8, true)
# eighth
## Multiplier-2
P9 = 169*X[1]^2//5000 + 109*X[1]*X[2]//10000 - 141*X[1]//10000 + 271*X[2]^2//10000 + 293*X[2]//5000 + 57//1000
M9 = [1, X[2], X[1]]
Q9 = [0.0572720996439881 0.029446685350644628 -0.0071114332440524045;
 0.029446685350644628 0.027104934461928687 0.0054305605071866105;
 -0.0071114332440524045 0.0054305605071866105 0.033428197570623895;
]
solve(n, X, P9, Q9, M9, true)
## Total Decomposition
P10 = 2703*X[1]^4//100000 - 4481*X[1]^3*X[2]//1000000 - 533*X[1]^3//1250 + 2281*X[1]^2*X[2]^2//50000 - 4919*X[1]^2*X[2]//10000 + 1579*X[1]^2//500 + 109*X[1]*X[2]^3//10000 - 4063*X[1]*X[2]^2//10000 + 6047*X[1]*X[2]//10000 + 4567*X[1]//50000 + 1379*X[2]^4//50000 - 403*X[2]^3//1000 + 579*X[2]^2//125 - 1269*X[2]//1000 + 1171//1000
M10 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q10 = [1.1710924895845884 -0.6344963920888611 0.04622058498651362 0.04697857981585316 -0.008714915399365156 0.006856208913844121;
 -0.6344963920888611 4.537543665210382 0.3085345533993475 -0.20094525756986872 -0.22050607260712668 -0.060911900535392104;
 0.04622058498651362 0.3085345533993475 3.1433998608989415 0.018190702617557432 -0.18322775505170133 -0.21452418546611574;
 0.04697857981585316 -0.20094525756986872 0.018190702617557432 0.027104934461741288 0.005430560507160828 -0.004261609607354397;
 -0.008714915399365156 -0.22050607260712668 -0.18322775505170133 0.005430560507160828 0.05405546480011562 -0.0022343574644382615;
 0.006856208913844121 -0.060911900535392104 -0.21452418546611574 -0.004261609607354397 -0.0022343574644382615 0.02713531757774961;
]
solve(n, X, P10, Q10, M10, true)
## Multiplier-1
P11 = 11*X[1]^2//400 - 89*X[1]*X[2]//20000 + 161*X[1]//5000 + 3*X[2]^2//250 + X[2]//250 + 9//200
M11 = [1, X[2], X[1]]
Q11 = [0.04509686594760423 0.0020159468627699373 0.016126013944125796;
 0.0020159468627699373 0.0121040480151441 -0.0022343574642959235;
 0.016126013944125796 -0.0022343574642959235 0.027135317577972235;
]
solve(n, X, P11, Q11, M11, true)
# first
## Multiplier-2
P12 = 201*X[1]^2//10000 + 207*X[1]*X[2]//100000 + 11*X[1]//1250 + 903*X[2]^2//100000 - 63*X[2]//50000 + 627//1000
M12 = [1, X[2], X[1]]
Q12 = [0.6274940878551185 -0.0007171181794657874 0.00445529076661763;
 -0.0007171181794657874 0.009218949293601023 0.0010508953040671404;
 0.00445529076661763 0.0010508953040671404 0.020517316800314406;
]
solve(n, X, P12, Q12, M12, true)
## Total Decomposition
P13 = 139*X[1]^4//2000 + 241*X[1]^3*X[2]//50000 + 149*X[1]^3//20000 + 29*X[1]^2*X[2]^2//1000 - 243*X[1]^2*X[2]//100000 + 319*X[1]^2//5000 + 107*X[1]*X[2]^3//50000 + 901*X[1]*X[2]^2//100000 + 183*X[1]*X[2]//20000 - 26*X[1]//3125 + 463*X[2]^4//50000 - 9*X[2]^3//6250 - 13*X[2]^2//400 + 7*X[2]//2500 + 347//1000
M13 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q13 = [0.34692185742311576 0.001536245655055583 -0.0042903689048324825 -0.03688931937413541 8.300422641881353e-05 -0.03175644408417176;
 0.001536245655055583 0.04071064105671932 0.004524733954233984 -0.0007171181794657165 0.0032160333718324447 0.00017246368630368498;
 -0.0042903689048324825 0.004524733954233984 0.12789906310127291 0.001239257394785133 -0.0014344410462434614 0.003790988663093943;
 -0.03688931937413541 -0.0007171181794657165 0.001239257394785133 0.009218949293612435 0.001050895304067181 -0.005152324171572903;
 8.300422641881353e-05 0.0032160333718324447 -0.0014344410462434614 0.001050895304067181 0.039234558301716224 0.002377005791047368;
 -0.03175644408417176 0.00017246368630368498 0.003790988663093943 -0.005152324171572903 0.002377005791047368 0.06920777698875381;
]
solve(n, X, P13, Q13, M13, true)
## Multiplier-1
P14 = 43*X[1]^2//625 + 57*X[1]*X[2]//12500 + 19*X[1]//2500 + 81*X[2]^2//10000 - X[2]//400 + 49//500
M14 = [1, X[2], X[1]]
Q14 = [0.09777851117837075 -0.001261977359939918 0.0037909886630938727;
 -0.001261977359939918 0.008412596993071621 0.0023770057910474586;
 0.0037909886630938727 0.0023770057910474586 0.0692077769887535;
]
solve(n, X, P14, Q14, M14, true)
# fifth
## Multiplier-2
P15 = X[1]^2//1000 + X[1]*X[2]//8000 + 3*X[1]//50000 + 3*X[2]^2//2000 - 24*X[2]//3125 + 3//100
M15 = [1, X[2], X[1]]
Q15 = [0.029622451691641568 -0.003778532588291256 1.7023906321557425e-05;
 -0.003778532588291256 0.0018657182029237739 8.900257759602733e-05;
 1.7023906321557425e-05 8.900257759602733e-05 0.0011240482261685497;
]
solve(n, X, P15, Q15, M15, true)
## Total Decomposition
P16 = 73*X[1]^4//12500 + 37*X[1]^3*X[2]//50000 + 139*X[1]^3//100000 - 181*X[1]^2*X[2]^2//10000 + 521*X[1]^2*X[2]//100000 + 19*X[1]^2//250 - 79*X[1]*X[2]^3//50000 - 41*X[1]*X[2]^2//12500 + 477*X[1]*X[2]//50000 + 141*X[1]//100000 + 403*X[2]^4//10000 - 169*X[2]^3//2500 + 713*X[2]^2//10000 + 43*X[2]//2500 + 141//1000
M16 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q16 = [0.14053709123702202 0.008558272989168645 0.0006429824176371284 -0.016638299182743076 0.0006054101097648899 0.0029294646694215084;
 0.008558272989168645 0.1042485992659371 0.004203568164823858 -0.03373115756527368 0.00024093362292304372 0.008417030228696791;
 0.0006429824176371284 0.004203568164823858 0.07033794824842207 -0.0018614413384286238 -0.005832804475528291 0.0007027326788060973;
 -0.016638299182743076 -0.03373115756527368 -0.0018614413384286238 0.04050972036104437 -0.0007982319593135575 -0.012334132022575483;
 0.0006054101097648899 0.00024093362292304372 -0.005832804475528291 -0.0007982319593135575 0.006974786063903869 0.00038413948084264215;
 0.0029294646694215084 0.008417030228696791 0.0007027326788060973 -0.012334132022575483 0.00038413948084264215 0.0059749968002732416;
]
solve(n, X, P16, Q16, M16, true)
## Multiplier-1
P17 = 3*X[1]^2//1000 + 257*X[1]*X[2]//1000000 - X[1]//6250 + 101*X[2]^2//50000 - 127*X[2]//10000 + 1//25
M17 = [1, X[2], X[1]]
Q17 = [0.039603203615175116 -0.006314524999713452 -9.85999854158693e-05;
 -0.006314524999713452 0.002175116966747172 0.00015013359642719994;
 -9.85999854158693e-05 0.00015013359642719994 0.0031313833509139396;
]
solve(n, X, P17, Q17, M17, true)
# fourth
## Multiplier-2
P18 = 41*X[1]^2//10000 + 3*X[1]*X[2]//62500 + 39*X[1]//10000 + X[2]^2//1000 + 51//1000
M18 = [1, X[2], X[1]]
Q18 = [0.05088546968250434 -2.6484218102698033e-06 0.0019418616524010507;
 -2.6484218102698033e-06 0.0006357214373426137 1.521949182683889e-05;
 0.0019418616524010507 1.521949182683889e-05 0.004352868503793283;
]
solve(n, X, P18, Q18, M18, true)
## Total Decomposition
P19 = 29*X[1]^4//2500 + 37*X[1]^3*X[2]//25000 + 149*X[1]^3//25000 - 177*X[1]^2*X[2]^2//50000 - X[1]^2*X[2]//6250 + 869*X[1]^2//10000 - 581*X[1]*X[2]^3//1000000 + 153*X[1]*X[2]^2//100000 + 59*X[1]*X[2]//250000 + 359*X[1]//500000 + 101*X[2]^4//50000 + 41*X[2]^3//200000 + 7*X[2]^2//400 - 483*X[2]//1000000 + 3//25
M19 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q19 = [0.11951084533672736 -0.00027086603168177605 0.00034821186509174435 -0.006228032809665964 0.0007572540539678996 0.007373813368530565;
 -0.00027086603168177605 0.0300144274628483 -0.000587508850696051 0.00011486741718792125 0.0009220620263117496 -0.0001424393834587721;
 0.00034821186509174435 -0.000587508850696051 0.07203854845186075 -0.00015578461945573097 3.8047861837673937e-05 0.003006887179515671;
 -0.006228032809665964 0.00011486741718792125 -0.00015578461945573097 0.0021076238147913068 -0.00030563869488487507 -0.003459509103275895;
 0.0007572540539678996 0.0009220620263117496 3.8047861837673937e-05 -0.00030563869488487507 0.002640721371565014 0.000726074100705405;
 0.007373813368530565 -0.0001424393834587721 0.003006887179515671 -0.003459509103275895 0.000726074100705405 0.012241587075498887;
]
solve(n, X, P19, Q19, M19, true)
## Multiplier-1
P20 = 3*X[1]^2//1000 - 17*X[1]*X[2]//100000 + 7*X[1]//5000 + X[2]^2//1000 + X[2]//25000 + 1//50
M20 = [1, X[2], X[1]]
Q20 = [0.019534170530589742 2.6504213638273043e-05 0.0006839715626568209;
 2.6504213638273043e-05 0.0005898530573030462 -4.902454033464121e-05;
 0.0006839715626568209 -4.902454033464121e-05 0.0025894441016572714;
]
solve(n, X, P20, Q20, M20, true)
# sixth
## Multiplier-2
P21 = 1//250
M21 = [1, X[2], X[1]]
Q21 = [0.0036772546546053105 -3.0318240458645646e-21 -8.264025041881044e-20;
 -3.0318240458645646e-21 4.406878949119426e-05 8.778244327681986e-21;
 -8.264025041881044e-20 8.778244327681986e-21 2.3014259484202602e-05;
]
solve(n, X, P21, Q21, M21, true)
## Total Decomposition
P22 = 197*X[1]^4//10000000 + 197*X[1]^2*X[2]^2//5000000 - 6*X[1]^2//3125 + 197*X[2]^4//10000000 - 6*X[2]^2//3125 + 197//1000
M22 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q22 = [0.19749031449951626 -2.3473765536538817e-18 8.181036781107484e-21 -0.0019752019012169485 -1.1975889226250253e-19 -0.0019752019001481745;
 -2.3473765536538817e-18 0.0015734133772212907 -1.551007921061559e-18 -4.162491915363479e-20 -1.3634184057079566e-19 -2.2950950829481967e-20;
 8.181036781107484e-21 -1.551007921061559e-18 0.0015734133748087932 -6.537622270178611e-20 2.1869681963178555e-23 1.3397798374142298e-19;
 -0.0019752019012169485 -4.162491915363479e-20 -6.537622270178611e-20 4.406878950485207e-05 8.7782172664036e-21 8.054020238931687e-06;
 -1.1975889226250253e-19 -1.3634184057079566e-19 2.1869681963178555e-23 8.7782172664036e-21 2.992047810754142e-05 8.048277847438038e-21;
 -0.0019752019001481745 -2.2950950829481967e-20 1.3397798374142298e-19 8.054020238931687e-06 8.048277847438038e-21 4.406878942077017e-05;
]
solve(n, X, P22, Q22, M22, true)
## Multiplier-1
P23 = 1//250
M23 = [1, X[2], X[1]]
Q23 = [0.0036772547048439363 3.277173809411451e-20 8.254960196111547e-20;
 3.277173809411451e-20 2.3014259536923847e-05 8.048250744335586e-21;
 8.254960196111547e-20 8.048250744335586e-21 4.4068789465325766e-05;
]
solve(n, X, P23, Q23, M23, true)

@show SOS_time Newton_time