include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50



SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 3
@Symbolics.variables X[1:n]
#C7
# init
## Total Decomposition
P0 = 6433*X[1]^4//1000000 + 3609*X[1]^3*X[2]//5000000 - 1057*X[1]^3*X[3]//1000000 + 917*X[1]^3//5000 + 1267*X[1]^2*X[2]^2//100000 - 1033*X[1]^2*X[2]*X[3]//1000000 + 2207*X[1]^2*X[2]//10000 + 63*X[1]^2*X[3]^2//5000 - 122*X[1]^2*X[3]//625 + 1683*X[1]^2//500 + 821*X[1]*X[2]^3//500000 - 809*X[1]*X[2]^2*X[3]//500000 + 411*X[1]*X[2]^2//2000 + 299*X[1]*X[2]*X[3]^2//200000 - 4973*X[1]*X[2]*X[3]//50000 + 4369*X[1]*X[2]//5000 - 1531*X[1]*X[3]^3//1000000 + 2061*X[1]*X[3]^2//10000 - 869*X[1]*X[3]//1250 - 2439*X[1]//10000 + 1409*X[2]^4//250000 - 1311*X[2]^3*X[3]//1000000 + 869*X[2]^3//5000 + 73*X[2]^2*X[3]^2//6250 - 1831*X[2]^2*X[3]//10000 + 697*X[2]^2//200 - 639*X[2]*X[3]^3//500000 + 493*X[2]*X[3]^2//2500 - 373*X[2]*X[3]//625 - 949*X[2]//5000 + 5661*X[3]^4//1000000 - 297*X[3]^3//2000 + 3383*X[3]^2//1000 + 2633*X[3]//10000 + 242//125
M0 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q0 = [1.9355980184582093 0.1310231759029464 -0.09485448701568482 -0.12278194461284843 0.00031310198450536827 0.010752572795511187 0.011735076238374652 0.0003412634534402554 -0.011514816713746063 -0.0015982647541006889;
 0.1310231759029464 3.382859420389647 -0.31094574474020564 -0.3575783670434383 -0.07356886366757147 0.09155336503972024 0.09402156842305222 -0.005710812178224879 -0.014039053391721967 -0.01266203966467158;
 -0.09485448701568482 -0.31094574474020564 3.4850411752680226 0.44975293631121727 0.00703437840371867 -0.08374174007151598 -0.01802977031549833 0.08568974433791575 0.0956819662490734 0.015173928257614608;
 -0.12278194461284843 -0.3575783670434383 0.44975293631121727 3.3701354204864358 0.006269870710454965 -0.014720953777015407 -0.08500202622049806 0.006136284257281746 0.09388942623981326 0.09300567671402246;
 0.00031310198450536827 -0.07356886366757147 0.00703437840371867 0.006269870710454965 0.005899198769919292 -0.0005341589149739729 -0.000600890125284987 -0.0005816544080641475 0.0009250605662141332 -0.0004075507290889759;
 0.010752572795511187 0.09155336503972024 -0.08374174007151598 -0.014720953777015407 -0.0005341589149739729 0.012993152430312025 -0.0003701263550407354 -0.000534158911819768 0.000288173162825437 -0.001045933653967336;
 0.011735076238374652 0.09402156842305222 -0.01802977031549833 -0.08500202622049806 -0.000600890125284987 -0.0003701263550407354 0.013147049753835351 -0.0008890632951958173 0.000511774748615793 -0.0006008901317923295;
 0.0003412634534402554 -0.005710812178224879 0.08568974433791575 0.006136284257281746 -0.0005816544080641475 -0.000534158911819768 -0.0008890632951958173 0.005930645194010172 0.0005549342145338313 -0.0002700594275655996;
 -0.011514816713746063 -0.014039053391721967 0.0956819662490734 0.09388942623981326 0.0009250605662141332 0.000288173162825437 0.000511774748615793 0.0005549342145338313 0.012903513541574587 0.0005549342020381035;
 -0.0015982647541006889 -0.01266203966467158 0.015173928257614608 0.09300567671402246 -0.0004075507290889759 -0.001045933653967336 -0.0006008901317923295 -0.0002700594275655996 0.0005549342020381035 0.006432749846401779;
]
solve(n, X, P0, Q0, M0, true)
## Multiplier-1
P1 = 61*X[1]^2//10000 + 57*X[1]*X[2]//50000 - 3*X[1]*X[3]//2500 - 29*X[1]//50000 + 303*X[2]^2//50000 - 109*X[2]*X[3]//100000 - 329*X[2]//500000 + 3*X[3]^2//500 + 37*X[3]//100000 + 3//1000
M1 = [1, X[3], X[2], X[1]]
Q1 = [0.002777970166422882 0.00017111667706563941 -0.0003046051812513156 -0.0002691906780859573;
 0.00017111667706563941 0.005899198779176732 -0.000534158915423934 -0.0006008901270159891;
 -0.0003046051812513156 -0.000534158915423934 0.005930645170165349 0.0005549342054979858;
 -0.0002691906780859573 -0.0006008901270159891 0.0005549342054979858 0.00643274984966117;
]
solve(n, X, P1, Q1, M1, true)
# unsafe
## Total Decomposition
P2 = 359*X[1]^4//40000 + 833*X[1]^3*X[2]//200000 - 5411*X[1]^3*X[3]//10000000 + 123*X[1]^3//400 + 367*X[1]^2*X[2]^2//20000 - 509*X[1]^2*X[2]*X[3]//2000000 + 947*X[1]^2*X[2]//2500 + 1741*X[1]^2*X[3]^2//100000 - 3237*X[1]^2*X[3]//50000 + 4817*X[1]^2//1000 + 231*X[1]*X[2]^3//62500 - 3423*X[1]*X[2]^2*X[3]//10000000 + 521*X[1]*X[2]^2//1250 + 3679*X[1]*X[2]*X[3]^2//1000000 - 1191*X[1]*X[2]*X[3]//25000 + 691*X[1]*X[2]//500 - 539*X[1]*X[3]^3//1000000 + 323*X[1]*X[3]^2//1250 - 309*X[1]*X[3]//1250 - 4209*X[1]//10000 + 9267*X[2]^4//1000000 - 287*X[2]^3*X[3]//625000 + 2701*X[2]^3//10000 + 861*X[2]^2*X[3]^2//50000 - 6027*X[2]^2*X[3]//100000 + 4501*X[2]^2//1000 - 1251*X[2]*X[3]^3//2500000 + 1139*X[2]*X[3]^2//5000 - 2393*X[2]*X[3]//10000 - 4209*X[2]//10000 + 817*X[3]^4//100000 - 3801*X[3]^3//100000 + 3811*X[3]^2//1000 + 831*X[3]//200000 + 2063//1000
M2 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q2 = [2.062770503739283 0.0030416622037749853 -0.21142324327619563 -0.2113362734860681 0.006691348613874214 0.0029823512930410305 0.0030743537154371155 -0.004870264483358225 -0.02474478091380239 -0.005398407734830337;
 0.0030416622037749853 3.7990351079913 -0.12239148850884539 -0.1255814825569234 -0.019266176524871084 0.11291610032517538 0.12806916947862976 -0.004121550186202239 -0.008408071619065477 -0.003536533731396327;
 -0.21142324327619563 -0.12239148850884539 4.509370399687874 0.7181611935976988 0.0006576094593524447 -0.027090046993961652 -0.008273239429686363 0.13619514420372866 0.17675905661557556 0.020043960998489728;
 -0.2113362734860681 -0.1255814825569234 0.7181611935976988 4.829934984586311 0.0010426861872528403 -0.009483644607941363 -0.029068709005102094 0.02937670548498998 0.17207518256750443 0.15226236106759997;
 0.006691348613874214 -0.019266176524871084 0.0006576094593524447 0.0010426861872528403 0.00777394926908811 -0.0002694111506620403 -0.00029123582568552493 -0.0010822790196003333 0.002095758457055074 -0.001031674534516206;
 0.0029823512930410305 0.11291610032517538 -0.027090046993961652 -0.009483644607941363 -0.0002694111506620403 0.01936545520159946 -0.0003300480836216644 -0.00026941110324734465 7.371020857228112e-05 -0.000291478282560662;
 0.0030743537154371155 0.12806916947862976 -0.008273239429686363 -0.029068709005102094 -0.00029123582568552493 -0.0003300480836216644 0.019102561004811277 -0.0003649459934497383 2.2067170965073357e-05 -0.0002912357789035863;
 -0.004870264483358225 -0.004121550186202239 0.13619514420372866 0.02937670548498998 -0.0010822790196003333 -0.00026941110324734465 -0.0003649459934497383 0.00942694771550324 0.0017657101101425916 -0.00020687696966273248;
 -0.02474478091380239 -0.008408071619065477 0.17675905661557556 0.17207518256750443 0.002095758457055074 7.371020857228112e-05 2.2067170965073357e-05 0.0017657101101425916 0.019105963790476767 0.0017657100823096103;
 -0.005398407734830337 -0.003536533731396327 0.020043960998489728 0.15226236106759997 -0.001031674534516206 -0.000291478282560662 -0.0002912357789035863 -0.00020687696966273248 0.0017657100823096103 0.009265262324473807;
]
solve(n, X, P2, Q2, M2, true)
## Multiplier-1
P3 = 471*X[1]^2//50000 + 341*X[1]*X[2]//100000 - 303*X[1]*X[3]//500000 - X[1]//800 + 91*X[2]^2//10000 - 549*X[2]*X[3]//1000000 - 101*X[2]//100000 + 81*X[3]^2//10000 + 17*X[3]//50000 + 1//200
M3 = [1, X[3], X[2], X[1]]
Q3 = [0.004906589411879487 0.0001686943093302267 -0.0004955966277430193 -0.0006144709869609573;
 0.0001686943093302267 0.007773948342213584 -0.00026941111385089177 -0.00029123578293260605;
 -0.0004955966277430193 -0.00026941111385089177 0.009426947701855131 0.0017657101504906607;
 -0.0006144709869609573 -0.00029123578293260605 0.0017657101504906607 0.00926526219494847;
]
solve(n, X, P3, Q3, M3, true)
# Lie
## Multiplier-3
P4 = 23*X[1]^2//1000 - 177*X[1]*X[2]//25000 - 21*X[1]*X[3]//100000 + 221*X[1]//50000 + 13*X[2]^2//6250 - 229*X[2]*X[3]//2500000 - 217*X[2]//500000 + 69*X[3]^2//1000000 - 43*X[3]//250000 + 111//250000
M4 = [1, X[3], X[2], X[1]]
Q4 = [0.00044931836352927687 -8.673457977301321e-05 -0.00021749688512648363 0.002229974564002462;
 -8.673457977301321e-05 7.164365729250586e-05 -5.039090575862275e-05 -8.968455695214223e-05;
 -0.00021749688512648363 -5.039090575862275e-05 0.0019909786955320686 -0.0034721111135556293;
 0.002229974564002462 -8.968455695214223e-05 -0.0034721111135556293 0.023415659318844092;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-2
P5 = 329*X[1]^2//100000 - 523*X[1]*X[2]//100000 + 59*X[1]*X[3]//200000 + 3*X[2]^2//1000 - 383*X[2]*X[3]//1000000 + 91*X[3]^2//2500000
M5 = [1, X[3], X[2], X[1]]
Q5 = [0.00018840958595127373 -3.263474043793915e-05 -8.433020059890088e-06 0.00019852165022042745;
 -3.263474043793915e-05 2.6343031491746258e-05 -0.00010719890687234314 4.938513747031476e-05;
 -8.433020059890088e-06 -0.00010719890687234314 0.0021643346761405615 -0.0019045967207311685;
 0.00019852165022042745 4.938513747031476e-05 -0.0019045967207311685 0.003308353941753331;
]
solve(n, X, P5, Q5, M5, true)
## Total Decomposition
P6 = 233*X[1]^4//50000 - 23*X[1]^3*X[2]//6250 + 7*X[1]^3*X[3]//78125 - 579*X[1]^3//100000 + 449*X[1]^2*X[2]^2//100000 + 321*X[1]^2*X[2]*X[3]//1000000 - 189*X[1]^2*X[2]//10000 + 237*X[1]^2*X[3]^2//10000 - 159*X[1]^2*X[3]//500 + 13*X[1]^2//10 - 187*X[1]*X[2]^3//50000 - 941*X[1]*X[2]^2*X[3]//10000000 - 637*X[1]*X[2]^2//100000 - 391*X[1]*X[2]*X[3]^2//50000 - 149*X[1]*X[2]*X[3]//1000 + 61*X[1]*X[2]//50 - 193*X[1]*X[3]^3//2500000 + 113*X[1]*X[3]^2//10000 - 717*X[1]*X[3]//10000 + 99*X[1]//500 + 53*X[2]^4//25000 - 2*X[2]^3*X[3]//15625 + 147*X[2]^3//250000 + 127*X[2]^2*X[3]^2//50000 + 23*X[2]^2*X[3]//2000 + 457*X[2]^2//1000 - 313*X[2]*X[3]^3//1000000 - 37*X[2]*X[3]^2//25000 - 57*X[2]*X[3]//2500 + 51*X[2]//500 + 193*X[3]^4//2000000 - 189*X[3]^3//100000 + 49*X[3]^2//2500 - 277*X[3]//10000 + 69//1000
M6 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q6 = [0.06891917321494594 -0.013869314956518478 0.05085201032127733 0.09887029651469248 0.00042121062132799344 0.0014654359096359483 -0.013290434805598926 -0.0008069820292013465 0.0006284824308058969 0.0008082664159346554;
 -0.013869314956518478 0.01834610033957457 -0.01283433794252193 -0.022540145554374558 -0.0009223381989482179 -0.001145172540753075 0.0044182746874726515 0.001275122947776913 -0.0013015739134318118 -0.001484683740959091;
 0.05085201032127733 -0.01283433794252193 0.4577584124568588 0.6063535547363622 0.00021846537065615395 0.004545130903252228 -0.08396857392683435 9.749616683223049e-05 -0.004202542776436568 -0.002693283260859564;
 0.09887029651469248 -0.022540145554374558 0.6063535547363622 1.299939329828646 0.0009389210164288718 0.011338805458237535 -0.15732834570804088 0.0006382191030374813 -0.006567250341419247 -0.002541978435469676;
 0.00042121062132799344 -0.0009223381989482179 0.00021846537065615395 0.0009389210164288718 7.164365779928025e-05 -5.039090595695577e-05 -8.968455689205304e-05 -7.414158488486917e-05 7.27459328164733e-05 7.051843918630532e-05;
 0.0014654359096359483 -0.001145172540753075 0.004545130903252228 0.011338805458237535 -5.039090595695577e-05 0.0021656029117392925 -0.003544857046390764 -0.00010719890686404677 -7.084985994747045e-05 0.00016426885088692658;
 -0.013290434805598926 0.0044182746874726515 -0.08396857392683435 -0.15732834570804088 -8.968455689205304e-05 -0.003544857046390764 0.023297968535131997 0.00012023499737161404 -0.0002116323555697982 9.51617635833874e-06;
 -0.0008069820292013465 0.001275122947776913 9.749616683223049e-05 0.0006382191030374813 -7.414158488486917e-05 -0.00010719890686404677 0.00012023499737161404 0.002164334676065202 -0.0019045967207400177 -0.0010311479002412696;
 0.0006284824308058969 -0.0013015739134318118 -0.004202542776436568 -0.006567250341419247 7.27459328164733e-05 -7.084985994747045e-05 -0.0002116323555697982 -0.0019045967207400177 0.006661944349633871 -0.0017816564716237053;
 0.0008082664159346554 -0.001484683740959091 -0.002693283260859564 -0.002541978435469676 7.051843918630532e-05 0.00016426885088692658 9.51617635833874e-06 -0.0010311479002412696 -0.0017816564716237053 0.004360350161359862;
]
solve(n, X, P6, Q6, M6, true)
## Multiplier-1
P7 = X[1]^2//200 - 343*X[1]*X[2]//100000 - 19*X[1]*X[3]//100000 + 59*X[1]//50000 + 23*X[2]^2//20000 + 417*X[2]*X[3]//10000000 - 53*X[2]//200000 + 17*X[3]^2//2000000 - 27*X[3]//250000 + 43//125000
M7 = [1, X[3], X[2], X[1]]
Q7 = [0.00019730872819687955 -3.0935782939623827e-05 -7.612321007921187e-05 0.0003376449840061274;
 -3.0935782939623827e-05 2.3348078289912304e-05 -4.73635048048411e-05 9.51617634549879e-06;
 -7.612321007921187e-05 -4.73635048048411e-05 0.0012912965917736509 -0.0017816564716121835;
 0.0003376449840061274 9.51617634549879e-06 -0.0017816564716121835 0.004360350161407844;
]
solve(n, X, P7, Q7, M7, true)

@show SOS_time Newton_time