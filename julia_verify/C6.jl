include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50


function solve(n, X, f, Q, mono,newton)
    
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]

#C6
# init
## Total Decomposition
P0 = 583*X[1]^4//200 + 903*X[1]^3*X[2]//25000 - 289*X[1]^3//2500 + 2959*X[1]^2*X[2]^2//500 - 2523*X[1]^2*X[2]//1000 + 5721*X[1]^2//1000 + 879*X[1]*X[2]^3//25000 - 321*X[1]*X[2]^2//2000 + 2891*X[1]*X[2]//5000 + 191*X[1]//100 + 601*X[2]^4//200 - 2611*X[2]^3//1000 + 2197*X[2]^2//1000 + 689*X[2]//200 + 533//125
M0 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q0 = [4.264034877350244 1.7236347523489437 0.9531399007445733 -1.046928810818363 -0.13567884299278532 0.2126962527709191;
 1.7236347523489437 4.2959844980482 0.42644336955093626 -1.3051815991512064 0.07851671497847401 -0.2789990119459199;
 0.9531399007445733 0.42644336955093626 5.293099202062077 -0.1561739551262674 -0.9820899862686169 -0.05943514189362127;
 -1.046928810818363 -1.3051815991512064 -0.1561739551262674 3.003304237267653 0.018222098254172543 0.3644031670483756;
 -0.13567884299278532 0.07851671497847401 -0.9820899862686169 0.018222098254172543 5.189616938565208 0.01822209825417233;
 0.2126962527709191 -0.2789990119459199 -0.05943514189362127 0.3644031670483756 0.01822209825417233 2.9151190353943077;
]
solve(n, X, P0, Q0, M0, true)
## Multiplier-1
P1 = 583*X[1]^2//200 + 447*X[1]*X[2]//12500 - 601*X[1]//5000 + 3003*X[2]^2//1000 + 3909*X[2]//10000 + 3759//1000
M1 = [1, X[2], X[1]]
Q1 = [3.7587134228774177 0.19647051948261918 -0.05943514189362102;
 0.19647051948261918 3.0033042372676513 0.01822209825417181;
 -0.05943514189362102 0.01822209825417181 2.9151190353943086;
]
solve(n, X, P1, Q1, M1, true)
# unsafe
## Total Decomposition
P2 = 9501*X[1]^4//10000 + 2699*X[1]^3*X[2]//100000 + 223*X[1]^3//100 + 889*X[1]^2*X[2]^2//500 + 1337*X[1]^2*X[2]//500 + 2377*X[1]^2//1000 + 663*X[1]*X[2]^3//25000 + 487*X[1]*X[2]^2//250 - 599*X[1]*X[2]//200 + 6799*X[1]//100000 + 331*X[2]^4//400 + 2213*X[2]^3//1000 + 6063*X[2]^2//1000 - 907*X[2]//250 + 309//100
M2 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q2 = [3.0902026362665027 -1.812714782967053 0.03528730719698347 -0.04760293532518426 -0.9885354582983018 -0.4780366802994209;
 -1.812714782967053 6.154771586864959 -0.5082880725531536 1.1095637122965458 1.0762494007165397 0.6669776540285086;
 0.03528730719698347 -0.5082880725531536 3.335232100520449 -0.09989928503396761 0.6681123111718837 1.1162520920992174;
 -0.04760293532518426 1.1095637122965458 -0.09989928503396761 0.8288086036734358 0.01427071444907702 0.0023994596854600148;
 -0.9885354582983018 1.0762494007165397 0.6681123111718837 0.01427071444907702 1.7746277122598824 0.014270714449082983;
 -0.4780366802994209 0.6669776540285086 1.1162520920992174 0.0023994596854600148 0.014270714449082983 0.9506180279676933;
]
solve(n, X, P2, Q2, M2, true)
## Multiplier-1
P3 = 19*X[1]^2//20 + 183*X[1]*X[2]//6250 - 309*X[1]//500 + 8287*X[2]^2//10000 - 2689*X[2]//10000 + 309//200
M3 = [1, X[2], X[1]]
Q3 = [1.5446841634847397 -0.13364902906334017 -0.30967474293703234;
 -0.13364902906334017 0.8288085048717446 0.014270712747872215;
 -0.30967474293703234 0.014270712747872215 0.9506179146452335;
]
solve(n, X, P3, Q3, M3, true)
# Lie
## Multiplier-2
P4 = 7197*X[1]^4//100000 + 4963*X[1]^3*X[2]//1000000 + 3983*X[1]^3//100000 + 4843*X[1]^2*X[2]^2//10000 - 5873*X[1]^2*X[2]//100000 - 1047*X[1]^2//5000 + 7237*X[1]*X[2]^3//100000 + 3669*X[1]*X[2]^2//10000 + 4073*X[1]*X[2]//10000 + 2403*X[1]//10000 + 1967*X[2]^4//5000 + 1909*X[2]^3//25000 + 87*X[2]^2//40 + 2829*X[2]//1000 + 1201//1000
M4 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q4 = [1.201772653505619 1.4150400324738024 0.11957517414430822 -0.02268849218630746 0.053856613372542446 -0.1740094509001094;
 1.4150400324738024 2.2200338137815754 0.14889277321722552 0.03790315757397001 0.17160808050214232 -0.17507084516141763;
 0.11957517414430822 0.14889277321722552 0.1383600856723442 0.012003998269862396 0.14554885473685705 0.019988838820617538;
 -0.02268849218630746 0.03790315757397001 0.012003998269862396 0.3938270710369329 0.0360231870619143 0.0035712609424684845;
 0.053856613372542446 0.17160808050214232 0.14554885473685705 0.0360231870619143 0.4767533519123179 0.002560084897197616;
 -0.1740094509001094 -0.17507084516141763 0.019988838820617538 0.0035712609424684845 0.002560084897197616 0.07206017524919513;
]
solve(n, X, P4, Q4, M4, true)
## Total Decomposition
P5 = 1771*X[1]^6//10000 + 707*X[1]^5*X[2]//50000 + 43*X[1]^5//250 + 5731*X[1]^4*X[2]^2//1000 + 2583*X[1]^4*X[2]//5000 - 813*X[1]^4//1250 + 9561*X[1]^3*X[2]^3//10000 + 101*X[1]^3*X[2]^2//25 + 2473*X[1]^3*X[2]//5000 - 206*X[1]^3//625 + 7183*X[1]^2*X[2]^4//10000 - 199*X[1]^2*X[2]^3//1000 - 2271*X[1]^2*X[2]^2//1000 + 277*X[1]^2*X[2]//125 + 133*X[1]^2//125 + 723*X[1]*X[2]^5//10000 + 917*X[1]*X[2]^4//2500 - 131*X[1]*X[2]^3//3125 - 9797*X[1]*X[2]^2//10000 + 529*X[1]*X[2]//1250 + 389*X[1]//1000 + 3941*X[2]^6//10000 + 3783*X[2]^5//50000 - 687*X[2]^4//2000 - 3931*X[2]^3//10000 + 391*X[2]^2//250 + 911*X[2]//1000 + 997//1000
M5 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2, X[2]^3, X[1]*X[2]^2, X[1]^2*X[2], X[1]^3]
Q5 = [0.9972820000264478 0.4557886092322513 0.19489109336012664 -0.15108622529188961 0.29049026048046495 -0.17188076221865992 -0.19262899975354225 0.001499268168407031 0.781071173506925 -0.057426338743905285;
 0.4557886092322513 1.8648680677524845 -0.07789738241125933 -0.004785699300579078 -0.375504052540037 -0.11269919733240606 -0.41318099137519954 -0.015567785718083002 -1.1946629790970134 0.024718827399058858;
 0.19489109336012664 -0.07789738241125933 1.4068582788203738 -0.11560981886403135 0.44068371388540917 -0.10749997830848886 -0.0009511287825670308 -0.6687918714679969 0.13788701910240714 -0.433622079891041;
 -0.15108622529188961 -0.004785699300579078 -0.11560981886403135 0.48186785844626756 -0.004638510837767097 0.01443879278002328 0.0379031575739708 0.18516167288932578 -0.12207458479455215 0.035082869700611564;
 0.29049026048046495 -0.375504052540037 0.44068371388540917 -0.004638510837767097 1.4289237057367183 0.08453234723100443 -0.0015495941173189157 0.02362755556461336 1.836156665241391 -0.08254766705831773;
 -0.17188076221865992 -0.11269919733240606 -0.10749997830848886 0.01443879278002328 0.08453234723100443 0.2179174736270533 -0.0013753747238887477 0.14864935716122774 0.339864849273531 0.08609504260643627;
 -0.19262899975354225 -0.41318099137519954 -0.0009511287825670308 0.0379031575739708 -0.0015495941173189157 -0.0013753747238887477 0.39382707103693504 0.03602318706191398 -0.16577380373792414 -0.0017834897049926232;
 0.001499268168407031 -0.015567785718083002 -0.6687918714679969 0.18516167288932578 0.02362755556461336 0.14864935716122774 0.03602318706191398 1.0514041488691468 0.47930257849148966 0.24194087952177226;
 0.781071173506925 -1.1946629790970134 0.13788701910240714 -0.12207458479455215 1.836156665241391 0.339864849273531 -0.16577380373792414 0.47930257849148966 5.245287081232247 0.007179411920136905;
 -0.057426338743905285 0.024718827399058858 -0.433622079891041 0.035082869700611564 -0.08254766705831773 0.08609504260643627 -0.0017834897049926232 0.24194087952177226 0.007179411920136905 0.17699999627445875;
]
solve(n, X, P5, Q5, M5, true)
## Multiplier-1
P6 = 177*X[1]^4//1000 + 29*X[1]^3*X[2]//2000 + 43*X[1]^3//250 + 267*X[1]^2*X[2]^2//1000 + 257*X[1]^2*X[2]//500 + 347*X[1]^2//1000 + 199*X[1]*X[2]^3//5000 + 137*X[1]*X[2]^2//1000 + 573*X[1]*X[2]//1000 + 57*X[1]//125 + 59*X[2]^4//250 - 7*X[2]^3//50 + 943*X[2]^2//1000 + 7*X[2]//5 + 771//1000
M6 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q6 = [0.770618272066736 0.7012950251521625 0.22797412774987283 -0.06488685265634268 0.05997596952389811 -0.020547083454356047;
 0.7012950251521625 1.0726896740032716 0.22612021147790043 -0.07030041352927022 0.09365825155640659 0.07472411035890848;
 0.22797412774987283 0.22612021147790043 0.38800816521052217 -0.02500075896293732 0.18259307185630388 0.08609504260644553;
 -0.06488685265634268 -0.07030041352927022 -0.02500075896293732 0.235960667800743 0.019953515920133717 -0.03420045862834018;
 0.05997596952389811 0.09365825155640659 0.18259307185630388 0.019953515920133717 0.33509643441664094 0.007179411920136026;
 -0.020547083454356047 0.07472411035890848 0.08609504260644553 -0.03420045862834018 0.007179411920136026 0.17699999627442978;
]
solve(n, X, P6, Q6, M6, true)