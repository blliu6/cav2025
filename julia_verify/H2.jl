include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-6
tol = 1e-50


function solve(n, X, f, Q, mono,newton)
    
    # Q = round.(Q, digits=1)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]



#H2
# third
## Multiplier-2
P0 = 319*X[1]^2//1000 - 167*X[1]*X[2]//2000 + 39*X[1]//1250 + 7*X[2]^2//20 + 13*X[2]//50 + 71//250
M0 = [1, X[2], X[1]]
Q0 = [0.28382850815316507 0.12967427014838953 0.01568180252549363;
 0.12967427014838953 0.3502939218597793 -0.041699767983166956;
 0.01568180252549363 -0.041699767983166956 0.3187774912614802;
]
solve(n, X, P0, Q0, M0, true)
## Total Decomposition
P1 = 4747*X[1]^4//100000 - 1421*X[1]^3*X[2]//10000 - 3433*X[1]^3//10000 + 1393*X[1]^2*X[2]^2//5000 - 1513*X[1]^2*X[2]//5000 + 361*X[1]^2//250 + 2671*X[1]*X[2]^3//5000 - 9*X[1]*X[2]^2//25 + 897*X[1]*X[2]//1250 - 1323*X[1]//1000 + 377*X[2]^4//400 - 1697*X[2]^3//2500 + 607*X[2]^2//250 - 1027*X[2]//1000 + 1901//1000
M1 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q1 = [1.9014437718794064 -0.5138869097069794 -0.6614438356653535 0.6552509167857892 0.16614424767346692 0.020306769317923398;
 -0.5138869097069794 1.1169313258600206 0.19372094432904446 -0.33896041565067603 -0.06432210858786555 -0.02385012123260061;
 -0.6614438356653535 0.19372094432904446 1.4028037798739368 -0.11561023513444901 -0.12680478539194215 -0.1711580646665811;
 0.6552509167857892 -0.33896041565067603 -0.11561023513444901 0.9421381807484726 0.267614124582245 -0.07234943256772039;
 0.16614424767346692 -0.06432210858786555 -0.12680478539194215 0.267614124582245 0.42355318706932177 -0.07129229473759031;
 0.020306769317923398 -0.02385012123260061 -0.1711580646665811 -0.07234943256772039 -0.07129229473759031 0.04743671434487744;
]
solve(n, X, P1, Q1, M1, true)
## Multiplier-1
P2 = 403*X[1]^2//10000 - 63*X[1]*X[2]//5000 + 459*X[1]//10000 + 697*X[2]^2//10000 + 319*X[2]//10000 + 11//250
M2 = [1, X[2], X[1]]
Q2 = [0.044054232497298874 0.01596486691998307 0.02295397762183445;
 0.01596486691998307 0.07004863942619055 -0.006316657213245564;
 0.02295397762183445 -0.006316657213245564 0.04045535757722457;
]
solve(n, X, P2, Q2, M2, true)
# second
## Multiplier-2
P3 = X[1]^2 - 157*X[1]*X[2]//2000 + 89*X[1]//1250 + 21*X[2]^2//20 + 431*X[2]//1000 + 757//1000
M3 = [1, X[2], X[1]]
Q3 = [0.7573571003995302 0.21553467836036783 0.035519426719952035;
 0.21553467836036783 1.0493408032173401 -0.03928006705289262;
 0.035519426719952035 -0.03928006705289262 1.0016998726357358;
]
solve(n, X, P3, Q3, M3, true)
## Total Decomposition
P4 = 2807*X[1]^4//10000 + 621*X[1]^3*X[2]//2500 - 2113*X[1]^3//2500 + 257*X[1]^2*X[2]^2//250 - 831*X[1]^2*X[2]//1250 + 2197*X[1]^2//1000 - 1139*X[1]*X[2]^3//25000 - 7549*X[1]*X[2]^2//10000 - 463*X[1]*X[2]//2500 - 87*X[1]//400 + 1039*X[2]^4//1000 - 16*X[2]^3//25 + 3233*X[2]^2//1000 - 6471*X[2]//10000 + 663//250
M4 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q4 = [2.6521110863785307 -0.3232912540222578 -0.10900444662311841 0.7018758728988643 -0.044922328486370705 0.09518038208283856;
 -0.3232912540222578 1.827655470166072 -0.04782061939642841 -0.319612447713101 -0.21277957364362524 -0.04295217878605615;
 -0.10900444662311841 -0.04782061939642841 2.005454795068076 -0.1653512160668749 -0.2883035265990964 -0.4222498203337983;
 0.7018758728988643 -0.319612447713101 -0.1653512160668749 1.0384760839765628 -0.022676653412060665 0.033983906626169916;
 -0.044922328486370705 -0.21277957364362524 -0.2883035265990964 -0.022676653412060665 0.9607613361815277 0.12448344890458139;
 0.09518038208283856 -0.04295217878605615 -0.4222498203337983 0.033983906626169916 0.12448344890458139 0.28085292171512255;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-1
P5 = 93*X[1]^2//1250 + 881*X[1]*X[2]//100000 + 103*X[1]//5000 + 101*X[2]^2//1250 + 33*X[2]//2000 + 81//1000
M5 = [1, X[2], X[1]]
Q5 = [0.08108080161142084 0.008256824400969571 0.010280487689229147;
 0.008256824400969571 0.08083629702660432 0.004393206908319369;
 0.010280487689229147 0.004393206908319369 0.07492325426347372;
]
solve(n, X, P5, Q5, M5, true)
# seventh
## Multiplier-2
P6 = 219*X[1]^2//1000 - 453*X[1]*X[2]//10000 - 171*X[1]//10000 + 53*X[2]^2//200 + 83*X[2]//500 + 97//500
M6 = [1, X[2], X[1]]
Q6 = [0.1944293572192533 0.08316012654468662 -0.008592283533770619;
 0.08316012654468662 0.2650353637509429 -0.022825869850912818;
 -0.008592283533770619 -0.022825869850912818 0.21894641117387822;
]
solve(n, X, P6, Q6, M6, true)
## Total Decomposition
P7 = 531*X[1]^4//125000 - 1229*X[1]^3*X[2]//100000 - 1101*X[1]^3//20000 + 629*X[1]^2*X[2]^2//2500 - 341*X[1]^2*X[2]//1000 + 893*X[1]^2//2000 - 4561*X[1]*X[2]^3//100000 - 3019*X[1]*X[2]^2//10000 - 3617*X[1]*X[2]//10000 - 1203*X[1]//5000 + 2647*X[2]^4//10000 - 417*X[2]^3//1000 + 293*X[2]^2//250 - 1677*X[2]//5000 + 371//250
M7 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q7 = [1.4835067636491186 -0.16834713574676702 -0.11999680833347746 0.23639034352226268 -0.20286360016322752 0.015805999301981326;
 -0.16834713574676702 0.7001809536350543 0.022503535254895415 -0.20837877602836663 -0.07336990629716415 0.0011167680591812471;
 -0.11999680833347746 0.022503535254895415 0.4141947162040311 -0.07745441308954458 -0.17157035223913875 -0.027665896567282137;
 0.23639034352226268 -0.20837877602836663 -0.07745441308954458 0.26503536375094533 -0.02282586985091219 0.007628295123576469;
 -0.20286360016322752 -0.07336990629716415 -0.17157035223913875 -0.02282586985091219 0.23576464602900601 -0.006006942761866741;
 0.015805999301981326 0.0011167680591812471 -0.027665896567282137 0.007628295123576469 -0.006006942761866741 0.004395504378841889;
]
solve(n, X, P7, Q7, M7, true)
## Multiplier-1
P8 = 87*X[1]^2//20000 - 121*X[1]*X[2]//10000 - 251*X[1]//100000 + 161*X[2]^2//5000 - 41*X[2]//12500 + 11//1000
M8 = [1, X[2], X[1]]
Q8 = [0.011385593977119178 -0.0016958436831445293 -0.001292891404353147;
 -0.0016958436831445293 0.03207482862219723 -0.00600694276180072;
 -0.001292891404353147 -0.00600694276180072 0.004395504379625855;
]
solve(n, X, P8, Q8, M8, true)
# eighth
## Total Decomposition
P9 = 22733*X[1]^4//25000 + 15587*X[1]^3*X[2]//100000 - 35297*X[1]^3//5000 + 14473*X[1]^2*X[2]^2//10000 - 38527*X[1]^2*X[2]//10000 + 2643*X[1]^2//200 + 3997*X[1]*X[2]^3//25000 - 44011*X[1]*X[2]^2//10000 + 1567*X[1]*X[2]//1000 + 127*X[1]//20 + 54041*X[2]^4//100000 - 283*X[2]^3//200 + 105*X[2]^2//8 + 381*X[2]//200 + 9337//1000
M9 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q9 = [9.336889371955113 0.9514210633317409 3.1758997553532673 0.6558302524211115 -1.1111092418428827 -1.0581547816275945;
 0.9514210633317409 11.819082826356821 1.8999136027326944 -0.7075189970182064 -2.098875167269456 -0.6294426328751043;
 3.1758997553532673 1.8999136027326944 15.327180277844516 -0.10410293041021645 -1.3108038817118877 -3.5278406239831517;
 0.6558302524211115 -0.7075189970182064 -0.10410293041021645 0.54037695532633 0.08004427213405492 -0.02657290793430401;
 -1.1111092418428827 -2.098875167269456 -1.3108038817118877 0.08004427213405492 1.502133883942186 0.08004426259325853;
 -1.0581547816275945 -0.6294426328751043 -3.5278406239831517 -0.02657290793430401 0.08004426259325853 0.9086110730737262;
]
solve(n, X, P9, Q9, M9, true)
## Multiplier-1
P10 = 227*X[1]^2//250 + 161*X[1]*X[2]//1000 + 667*X[1]//1000 + 541*X[2]^2//1000 + 103*X[2]//500 + 3//5
M10 = [1, X[2], X[1]]
Q10 = [0.6003124978642488 0.10304632067667785 0.3337564185552081;
 0.10304632067667785 0.5403768909090352 0.08004426259639325;
 0.3337564185552081 0.08004426259639325 0.908611073089476;
]
solve(n, X, P10, Q10, M10, true)
# first
## Multiplier-2
P11 = 201*X[1]^2//500 - 113*X[1]*X[2]//10000 + 203*X[1]//5000 + 461*X[2]^2//1000 + 27*X[2]//250 + 161//500
M11 = [1, X[2], X[1]]
Q11 = [0.3215944950226803 0.053584851559899734 0.020132523659062557;
 0.053584851559899734 0.46073262171232404 -0.005550663230437294;
 0.020132523659062557 -0.005550663230437294 0.40255361114272564;
]
solve(n, X, P11, Q11, M11, true)
## Total Decomposition
P12 = 3539*X[1]^4//100000 - 1251*X[1]^3*X[2]//250000 - 3703*X[1]^3//10000 + 1107*X[1]^2*X[2]^2//2500 - 51*X[1]^2*X[2]//200 + 139*X[1]^2//125 - 557*X[1]*X[2]^3//50000 - 3889*X[1]*X[2]^2//10000 + 3187*X[1]*X[2]//100000 - 133*X[1]//5000 + 4609*X[2]^4//10000 - 2387*X[2]^3//10000 + 289*X[2]^2//200 - 1523*X[2]//10000 + 1209//1000
M12 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q12 = [1.208829995014704 -0.07590800233600756 -0.013394001921379399 0.30176841947062755 -0.057105475394216294 -0.026295040835475434;
 -0.07590800233600756 0.8407617151445919 0.07260640738598247 -0.11918988158212313 -0.09655017581170604 -0.012024402528206888;
 -0.013394001921379399 0.07260640738598247 1.1648521847347706 -0.09760459605433805 -0.11529063763576984 -0.18455190108480107;
 0.30176841947062755 -0.11918988158212313 -0.09760459605433805 0.46073262171232454 -0.005550663230437277 0.007871504605157011;
 -0.057105475394216294 -0.09655017581170604 -0.11529063763576984 -0.005550663230437277 0.4265288370138634 -0.002383152316595207;
 -0.026295040835475434 -0.012024402528206888 -0.18455190108480107 0.007871504605157011 -0.002383152316595207 0.03481018714532865;
]
solve(n, X, P12, Q12, M12, true)
## Multiplier-1
P13 = 343*X[1]^2//10000 - 483*X[1]*X[2]//100000 + 69*X[1]//5000 + X[2]^2//25 - 51*X[2]//10000 + 39//1000
M13 = [1, X[2], X[1]]
Q13 = [0.03896150223737962 -0.0025721114680888257 0.006904128213063452;
 -0.0025721114680888257 0.03971823508170716 -0.0023831523165903533;
 0.006904128213063452 -0.0023831523165903533 0.03481018714542932;
]
solve(n, X, P13, Q13, M13, true)
# fifth
## Multiplier-2
P14 = 147*X[1]^2//500 - 9*X[1]*X[2]//250 - 727*X[1]//100000 + 231*X[2]^2//1000 + 33*X[2]//250 + 107//500
M14 = [1, X[2], X[1]]
Q14 = [0.21363964509323638 0.06569829590400701 -0.0036793632034913533;
 0.06569829590400701 0.23119314609888594 -0.018065574730495585;
 -0.0036793632034913533 -0.018065574730495585 0.2939795858416258;
]
solve(n, X, P14, Q14, M14, true)
## Total Decomposition
P15 = 259*X[1]^4//10000 - 871*X[1]^3*X[2]//10000 - 167*X[1]^3//1000 + 163*X[1]^2*X[2]^2//1000 - 137*X[1]^2*X[2]//1000 + 133*X[1]^2//200 + 199*X[1]*X[2]^3//1000 - 21*X[1]*X[2]^2//200 - 107*X[1]*X[2]//5000 - 433*X[1]//1000 + 11*X[2]^4//20 - 33*X[2]^3//125 + 59*X[2]^2//50 - 119*X[2]//500 + 107//125
M15 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q15 = [0.8563079187811844 -0.11896652332239603 -0.2164603897198664 0.293088761497628 0.009902091751160634 0.002220786658328752;
 -0.11896652332239603 0.5904810701176744 -0.020945300585569347 -0.13184774506007224 -0.010116586680722031 -0.00533274425814177;
 -0.2164603897198664 -0.020945300585569347 0.6607258459720784 -0.04249545187785571 -0.06300742565663832 -0.08384683171256883;
 0.293088761497628 -0.13184774506007224 -0.04249545187785571 0.5495044577819418 0.09902174095737418 -0.040026867544582755;
 0.009902091751160634 -0.010116586680722031 -0.06300742565663832 0.09902174095737418 0.24172260092696227 -0.04346448900642915;
 0.002220786658328752 -0.00533274425814177 -0.08384683171256883 -0.040026867544582755 -0.04346448900642915 0.02573082169507234;
]
solve(n, X, P15, Q15, M15, true)
## Multiplier-1
P16 = 53*X[1]^2//2500 - 17*X[1]*X[2]//3125 + 53*X[1]//2500 + 19*X[2]^2//500 + 41*X[2]//10000 + 29//1000
M16 = [1, X[2], X[1]]
Q16 = [0.02912778062001156 0.002031587169017276 0.010648591310544575;
 0.002031587169017276 0.037897348728120825 -0.002701728050541408;
 0.010648591310544575 -0.002701728050541408 0.021053765248871585;
]
solve(n, X, P16, Q16, M16, true)
# fourth
## Multiplier-2
P17 = 1029*X[1]^2//1000 - 9*X[1]*X[2]//50 - 681*X[1]//10000 + 23*X[2]^2//20 + 171*X[2]//200 + 921//1000
M17 = [1, X[2], X[1]]
Q17 = [0.9209526038639022 0.42701176099756905 -0.03371953660967128;
 0.42701176099756905 1.1510884022386412 -0.08959349072030257;
 -0.03371953660967128 -0.08959349072030257 1.0290760051588337;
]
solve(n, X, P17, Q17, M17, true)
## Total Decomposition
P18 = 897*X[1]^4//2500 + 137*X[1]^3*X[2]//400 - 9727*X[1]^3//10000 + 581*X[1]^2*X[2]^2//500 - 349*X[1]^2*X[2]//250 + 3621*X[1]^2//1000 - 877*X[1]*X[2]^3//10000 - 1149*X[1]*X[2]^2//1000 - 1187*X[1]*X[2]//10000 - 1041*X[1]//10000 + 559*X[2]^4//500 - 51*X[2]^3//40 + 4177*X[2]^2//1000 - 9461*X[2]//10000 + 217//50
M18 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q18 = [4.339798059970544 -0.4749893690824926 -0.05084398982733177 0.8148383135263396 -0.08390734344735955 0.27526482253968354;
 -0.4749893690824926 2.546233010302019 0.02311599478015993 -0.6375120600404625 -0.34359908984878895 -0.11078590583736846;
 -0.05084398982733177 0.02311599478015993 3.0736105037088866 -0.23118571895829804 -0.5898794490335044 -0.48715648345629237;
 0.8148383135263396 -0.6375120600404625 -0.23118571895829804 1.1170861778462278 -0.04396133642578503 0.024603801723640285;
 -0.08390734344735955 -0.34359908984878895 -0.5898794490335044 -0.04396133642578503 1.1138877186253093 0.17144222478417984;
 0.27526482253968354 -0.11078590583736846 -0.48715648345629237 0.024603801723640285 0.17144222478417984 0.35984967618976105;
]
solve(n, X, P18, Q18, M18, true)
## Multiplier-1
P19 = 433*X[1]^2//5000 - 39*X[1]*X[2]//6250 + 17*X[1]//625 + 3*X[2]^2//25 + 13*X[2]//10000 + 73//1000
M19 = [1, X[2], X[1]]
Q19 = [0.07328160137433508 0.0006604607668906086 0.013651749437545728;
 0.0006604607668906086 0.11977046486099853 -0.0030860358987311385;
 0.013651749437545728 -0.0030860358987311385 0.08646446314708378;
]
solve(n, X, P19, Q19, M19, true)
# sixth
## Multiplier-2
P20 = 239*X[1]^2//1000 - 81*X[1]*X[2]//2500 - 431*X[1]//100000 + 33*X[2]^2//125 + 159*X[2]//1000 + 49//250
M20 = [1, X[2], X[1]]
Q20 = [0.19564978155208274 0.07930570746135825 -0.002144360419685616;
 0.07930570746135825 0.26422211878465024 -0.016076896647390277;
 -0.002144360419685616 -0.016076896647390277 0.23947076003769208;
]
solve(n, X, P20, Q20, M20, true)
## Total Decomposition
P21 = 423*X[1]^4//125000 - X[1]^3*X[2]//100 - 181*X[1]^3//4000 + 2691*X[1]^2*X[2]^2//10000 - 447*X[1]^2*X[2]//1250 + 2001*X[1]^2//5000 - 1619*X[1]*X[2]^3//50000 - 1459*X[1]*X[2]^2//5000 - 3167*X[1]*X[2]//10000 - 2643*X[1]//10000 + 529*X[2]^4//2000 - 1839*X[2]^3//5000 + 1081*X[2]^2//1000 - 1593*X[2]//5000 + 247//200
M21 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q21 = [1.2348563646569821 -0.15955496321278204 -0.13229213102054482 0.22217510478088084 -0.17227590524356973 0.01630136300124722;
 -0.15955496321278204 0.6364435913843399 0.014669312676877516 -0.18359529669706942 -0.06855522004075178 0.0015653617532628197;
 -0.13229213102054482 0.014669312676877516 0.367900196974498 -0.0776962737254317 -0.18035816368152824 -0.022472347656224367;
 0.22217510478088084 -0.18359529669706942 -0.0776962737254317 0.26422211878465524 -0.016076896647388712 0.00700870242782766;
 -0.17227590524356973 -0.06855522004075178 -0.18035816368152824 -0.016076896647388712 0.25480338148674003 -0.0050697273205985854;
 0.01630136300124722 0.0015653617532628197 -0.022472347656224367 0.00700870242782766 -0.0050697273205985854 0.003471903114584089;
]
solve(n, X, P21, Q21, M21, true)
## Multiplier-1
P22 = 63*X[1]^2//20000 - X[1]*X[2]//100 - 33*X[1]//10000 + 291*X[2]^2//10000 - 273*X[2]//100000 + 13//1000
M22 = [1, X[2], X[1]]
Q22 = [0.012943083008937567 -0.0013561276896941082 -0.0016409608762798832;
 -0.0013561276896941082 0.029350031623469552 -0.005069727320701312;
 -0.0016409608762798832 -0.005069727320701312 0.0034719031147886544;
]
solve(n, X, P22, Q22, M22, true)