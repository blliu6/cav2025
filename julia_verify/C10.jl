include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50


SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 3
@Symbolics.variables X[1:n]

#C10
# init
## Total Decomposition
P0 = 2177*X[1]^4//500 + 9273*X[1]^3*X[2]//100000 - 133*X[1]^3*X[3]//2000 - 703*X[1]^3//500 + 437*X[1]^2*X[2]^2//50 + 4471*X[1]^2*X[2]*X[3]//10000 - 9429*X[1]^2*X[2]//10000 + 177*X[1]^2*X[3]^2//20 - 977*X[1]^2*X[3]//1250 + 2153*X[1]^2//1000 + 1169*X[1]*X[2]^3//12500 - 1321*X[1]*X[2]^2*X[3]//20000 - 1477*X[1]*X[2]^2//1000 + 2291*X[1]*X[2]*X[3]^2//25000 - 2381*X[1]*X[2]*X[3]//10000 - 641*X[1]*X[2]//125 - 3087*X[1]*X[3]^3//50000 - 1453*X[1]*X[3]^2//1000 + 327*X[1]*X[3]//100 + 553*X[1]//1000 + 2193*X[2]^4//500 + 571*X[2]^3*X[3]//1250 - 2297*X[2]^3//2500 + 8889*X[2]^2*X[3]^2//1000 - 1051*X[2]^2*X[3]//1000 + 3767*X[2]^2//1000 + 4543*X[2]*X[3]^3//10000 - 1197*X[2]*X[3]^2//1000 - 277*X[2]*X[3]//25 - 1053*X[2]//200 + 4499*X[3]^4//1000 - 8901*X[3]^3//10000 + 107*X[3]^2//40 - 477*X[3]//200 + 909//125
M0 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q0 = [7.272249122193595 -1.1914475096266637 -2.6339354029423334 0.27450042943826874 -1.3875268345656082 -3.6474485139499504 0.8660375153793343 -1.2704230150603513 -1.4139191496477899 -1.338103358217491;
 -1.1914475096266637 5.452259984250396 -1.8916506425774717 0.7672716220682213 -0.4429902406915274 -0.31643163007588404 -0.46638964240933034 -0.6021572742833047 0.39317162347934487 -0.07678077958692313;
 -2.6339354029423334 -1.8916506425774717 6.312642726859949 -1.1536294878630424 -0.283447525745124 0.07417492991095158 -0.3687777368016495 -0.45998740669506244 -0.2286071018141705 0.08074427070603458;
 0.27450042943826874 0.7672716220682213 -1.1536294878630424 4.827994671239047 -0.25634096282938457 -0.1443340434032151 -0.31542112708643505 -0.5044171909811873 -0.5551366763846682 -0.7021875511776001;
 -1.3875268345656082 -0.4429902406915274 -0.283447525745124 -0.25634096282938457 4.497128887304084 0.22488385280678497 -0.030245279957042154 0.44644160654511367 0.41570826607124844 0.8239699943063228;
 -3.6474485139499504 -0.31643163007588404 0.07417492991095158 -0.1443340434032151 0.22488385280678497 7.991575270627566 -0.3704665254699243 0.22488385280678636 0.3882675185079597 0.6508810769106816;
 0.8660375153793343 -0.46638964240933034 -0.3687777368016495 -0.31542112708643505 -0.030245279957042154 -0.3704665254699243 7.203655009836825 -0.4185127984650016 -0.4259972241039021 -0.03024527995704367;
 -1.2704230150603513 -0.6021572742833047 -0.45998740669506244 -0.5044171909811873 0.44644160654511367 0.22488385280678636 -0.4185127984650016 4.387329596413856 0.04524174060131956 0.7531204041526931;
 -1.4139191496477899 0.39317162347934487 -0.2286071018141705 -0.5551366763846682 0.41570826607124844 0.3882675185079597 -0.4259972241039021 0.04524174060131956 7.235554899253846 0.04524174060132163;
 -1.338103358217491 -0.07678077958692313 0.08074427070603458 -0.7021875511776001 0.8239699943063228 0.6508810769106816 -0.03024527995704367 0.7531204041526931 0.04524174060132163 4.3544661111454985;
]
solve(n, X, P0, Q0, M0, true)
## Multiplier-1
P1 = 2177*X[1]^2//500 + 9377*X[1]*X[2]//100000 - 6323*X[1]*X[3]//100000 + 7701*X[1]//10000 + 1097*X[2]^2//250 + 2267*X[2]*X[3]//5000 + 319*X[2]//250 + 4497*X[3]^2//1000 + 1361*X[3]//1000 + 301//50
M1 = [1, X[3], X[2], X[1]]
Q1 = [6.020037445658975 0.6812919811344589 0.63684499240838 0.3864289766087458;
 0.6812919811344589 4.497128887304072 0.22488385280678108 -0.030245279957042254;
 0.63684499240838 0.22488385280678108 4.3873295964138395 0.045241740601319996;
 0.3864289766087458 -0.030245279957042254 0.045241740601319996 4.354466111145495;
]
solve(n, X, P1, Q1, M1, true)
# unsafe
## Total Decomposition
P2 = 1231*X[1]^4//1000 - 62*X[1]^3*X[2]//125 - 7863*X[1]^3*X[3]//100000 - 1221*X[1]^3//500 + 1273*X[1]^2*X[2]^2//500 - 1433*X[1]^2*X[2]*X[3]//25000 + 1997*X[1]^2*X[2]//500 + 477*X[1]^2*X[3]^2//200 + 3*X[1]^2*X[3] + 9307*X[1]^2//1000 - 1241*X[1]*X[2]^3//2500 - 7923*X[1]*X[2]^2*X[3]//100000 - 4189*X[1]*X[2]^2//1000 - 4969*X[1]*X[2]*X[3]^2//10000 - 1551*X[1]*X[2]*X[3]//1000 + 4093*X[1]*X[2]//500 - 3971*X[1]*X[3]^3//50000 - 123*X[1]*X[3]^2//50 + 1689*X[1]*X[3]//1000 - 1019*X[1]//1000 + 164*X[2]^4//125 - 5719*X[2]^3*X[3]//100000 + 2741*X[2]^3//1000 + 1233*X[2]^2*X[3]^2//500 + 1413*X[2]^2*X[3]//500 + 8129*X[2]^2//1000 - 5549*X[2]*X[3]^3//100000 + 2103*X[2]*X[3]^2//1000 + 374*X[2]*X[3]//125 - 5961*X[2]//100000 + 577*X[3]^4//500 + 101*X[3]^3//40 + 1113*X[3]^2//125 - 1299*X[3]//1000 + 2123//500
M2 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q2 = [4.245905018950522 -0.6503346217712896 -0.030818575341580556 -0.508992060584106 0.3618679079231409 -0.24688295039782518 0.4750903063301933 0.06517305792392455 1.3817308621264621 0.19421230397905745;
 -0.6503346217712896 8.182347477365369 1.7444248879608182 0.3677993322722609 1.2634501006545882 0.8626441634002665 -1.1004038070634363 0.5500291612802648 -1.0516709062304836 0.4527466798696153;
 -0.030818575341580556 1.7444248879608182 8.002644155249996 2.7143081235507664 0.18975059369881464 0.8676544587417531 0.06503579315238447 1.3746620767803999 -1.6917383947574172 0.41244824132084007;
 -0.508992060584106 0.3677993322722609 2.7143081235507664 8.91729384425909 -0.1286058198780701 0.21031094786638704 1.0441722180981616 -0.3969043908513719 1.5788149523912507 -1.2235200980288885;
 0.3618679079231409 1.2634501006545882 0.18975059369881464 -0.1286058198780701 1.153998196239222 -0.028005636724177708 -0.039826392451974266 0.04373243429896648 -0.14261183966570132 0.010291689046052113;
 -0.24688295039782518 0.8626441634002665 0.8676544587417531 0.21031094786638704 -0.028005636724177708 2.3793651558115783 -0.10434215719207474 -0.028005636724179505 0.00911488590318074 -0.10896757340489861;
 0.4750903063301933 -1.1004038070634363 0.06503579315238447 1.0441722180981616 -0.039826392451974266 -0.10434215719207474 2.363406112892764 -0.04894127835515813 0.08096193668072188 -0.03982639245197403;
 0.06517305792392455 0.5500291612802648 1.3746620767803999 -0.3969043908513719 0.04373243429896648 -0.028005636724179505 -0.04894127835515813 1.3128318281898783 -0.2469539968577615 -0.1074698196867957;
 1.3817308621264621 -1.0516709062304836 -1.6917383947574172 1.5788149523912507 -0.14261183966570132 0.00911488590318074 0.08096193668072188 -0.2469539968577615 2.757762762309044 -0.246953996857763;
 0.19421230397905745 0.4527466798696153 0.41244824132084007 -1.2235200980288885 0.010291689046052113 -0.10896757340489861 -0.03982639245197403 -0.1074698196867957 -0.246953996857763 1.229991294765259;
]
solve(n, X, P2, Q2, M2, true)
## Multiplier-1
P3 = 1231*X[1]^2//1000 - 2469*X[1]*X[2]//5000 - 8049*X[1]*X[3]//100000 + 249*X[1]//200 + 1313*X[2]^2//1000 - 5573*X[2]*X[3]//100000 - 119*X[2]//100 + 231*X[3]^2//200 - 9369*X[3]//10000 + 183//100
M3 = [1, X[3], X[2], X[1]]
Q3 = [1.8299086894548595 -0.46754693158802135 -0.5945853598423599 0.6214665500653453;
 -0.46754693158802135 1.1539980586719485 -0.0280056333856496 -0.03982638770429401;
 -0.5945853598423599 -0.0280056333856496 1.3128316716881128 -0.24695396741858078;
 0.6214665500653453 -0.03982638770429401 -0.24695396741858078 1.229991148138861;
]
solve(n, X, P3, Q3, M3, true)
# Lie
## Multiplier-3
P4 = 331*X[1]^2//10000 - 33*X[1]*X[2]//250 + 51*X[1]*X[3]//250 + 139*X[1]//2000 + 33*X[2]^2//200 - 531*X[2]*X[3]//1000 - 39*X[2]//250 + 623*X[3]^2//1000 + 133*X[3]//500 + 213//5000
M4 = [1, X[3], X[2], X[1]]
Q4 = [0.042713303081695395 0.1333271006166058 -0.07808027418941156 0.03474672413469404;
 0.1333271006166058 0.6234758122268651 -0.2654392506104082 0.10188504929981043;
 -0.07808027418941156 -0.2654392506104082 0.16467143084460353 -0.06605679472426292;
 0.03474672413469404 0.10188504929981043 -0.06605679472426292 0.0325100865424657;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-2
P5 = 427*X[1]^2//10000 - 19*X[1]*X[2]//100 + 91*X[1]*X[3]//500 + 43*X[1]//500 + 257*X[2]^2//1000 - 87*X[2]*X[3]//200 - 101*X[2]//500 + 699*X[3]^2//1000 + 257*X[3]//1000 + 1//20
M5 = [1, X[3], X[2], X[1]]
Q5 = [0.0500671795786693 0.12833640345309663 -0.10097799336177321 0.04295046280354352;
 0.12833640345309663 0.6991918628058221 -0.21739488779802255 0.09075512561895682;
 -0.10097799336177321 -0.21739488779802255 0.2569043216767404 -0.09489787481739724;
 0.04295046280354352 0.09075512561895682 -0.09489787481739724 0.042469550771004005;
]
solve(n, X, P5, Q5, M5, true)
## Total Decomposition
P6 = 873*X[1]^4//200 - 9487*X[1]^3*X[2]//1000 - 4389*X[1]^3*X[3]//1000 + 4629*X[1]^3//5000 + 2609*X[1]^2*X[2]^2//500 + 4419*X[1]^2*X[2]*X[3]//1000 - 8301*X[1]^2*X[2]//10000 + 359*X[1]^2*X[3]^2//200 - 523*X[1]^2*X[3]//1250 - 1547*X[1]^2//250 - 1871*X[1]*X[2]^3//10000 + 1799*X[1]*X[2]^2*X[3]//10000 - 127*X[1]*X[2]^2//1250 - 171*X[1]*X[2]*X[3]^2//1250 + 6923*X[1]*X[2]*X[3]//10000 + 813*X[1]*X[2]//125 + 81*X[1]*X[3]^3//400 + 1551*X[1]*X[3]^2//5000 + 329*X[1]*X[3]//100 - 939*X[1]//2000 + 2571*X[2]^4//10000 - 4353*X[2]^3*X[3]//10000 - 2851*X[2]^3//10000 + 8637*X[2]^2*X[3]^2//10000 - 1917*X[2]^2*X[3]//5000 + 1379*X[2]^2//2500 - 1327*X[2]*X[3]^3//2500 - 139*X[2]*X[3]^2//250 - 1021*X[2]*X[3]//10000 - 5651*X[2]//10000 + 6233*X[3]^4//10000 + 41*X[3]^3//200 + 319*X[3]^2//250 + 2589*X[3]//10000 + 121//50
M6 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q6 = [2.419913942704922 0.1290782727772807 -0.2815188880058584 -0.2355567716016938 0.07610687000983335 0.06621251658930959 1.6532212626230276 0.06024578821997055 3.4034251915554283 -3.1827963014754763;
 0.1290782727772807 1.1259835548939936 -0.11528437109529834 -0.009505629438891853 0.10258554907694697 -0.2571782264490786 0.1647954855975914 -0.1527250121174936 0.25822862284607795 -0.08126761797475071;
 -0.2815188880058584 -0.11528437109529834 0.4290207912582893 -0.1522004172379065 -0.020836746586901815 -0.039782379638223335 0.010566936076054682 -0.1426897823582814 -0.08274799221270095 0.17183791440376403;
 -0.2355567716016938 -0.009505629438891853 -0.1522004172379065 0.17874224309231773 -0.009603262952923736 0.07703835887687249 -0.12789709114810494 0.03385520707525129 -0.5896061056728717 0.464042186713945;
 0.07610687000983335 0.10258554907694697 -0.020836746586901815 -0.009603262952923736 0.6234758122267825 -0.2654392506103985 0.10188504929979049 -0.009219569104544054 0.13790949923670714 -0.09989789736736181;
 0.06621251658930959 -0.2571782264490786 -0.039782379638223335 0.07703835887687249 -0.2654392506103985 0.8823024318455607 -0.2039662939609879 -0.21739488779802388 0.0707532768273493 -0.012702126459492914;
 1.6532212626230276 0.1647954855975914 0.010566936076054682 -0.12789709114810494 0.10188504929979049 -0.2039662939609879 1.9902664946240636 0.020001848791624727 2.218871743689232 -2.1933713045070857;
 0.06024578821997055 -0.1527250121174936 -0.1426897823582814 0.03385520707525129 -0.009219569104544054 -0.21739488779802388 0.020001848791624727 0.2569043216766087 -0.09489787481746746 -0.05307451582975158;
 3.4034251915554283 0.25822862284607795 -0.08274799221270095 -0.5896061056728717 0.13790949923670714 0.0707532768273493 2.218871743689232 -0.09489787481746746 5.326851925869951 -4.744210592957473;
 -3.1827963014754763 -0.08126761797475071 0.17183791440376403 0.464042186713945 -0.09989789736736181 -0.012702126459492914 -2.1933713045070857 -0.05307451582975158 -4.744210592957473 4.366421545074544;
]
solve(n, X, P6, Q6, M6, true)
## Multiplier-1
P7 = 893*X[1]^2//25000 + 2413*X[1]*X[2]//10000 + 3731*X[1]*X[3]//10000 + 131*X[1]//3125 + 5179*X[2]^2//1000 + 4411*X[2]*X[3]//1000 - 4277*X[2]//5000 + 879*X[3]^2//500 - 1001*X[3]//10000 + 6757//100000
M7 = [1, X[3], X[2], X[1]]
Q7 = [0.06797513916316683 -0.05033916281771731 -0.4289407020235181 0.020904631184206744;
 -0.05033916281771731 1.757960613361268 2.206169617230184 0.1870972894092434;
 -0.4289407020235181 2.206169617230184 5.178233343452686 0.12176483593164104;
 0.020904631184206744 0.1870972894092434 0.12176483593164104 0.0358629724895139;
]
solve(n, X, P7, Q7, M7, true)

@show SOS_time Newton_time