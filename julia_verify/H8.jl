include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-6
tol = 1e-50

SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]

#H8
# third
## Multiplier-2
P0 = 113*X[1]^2//5000 + 389*X[1]*X[2]//100000 - 29*X[1]//1250 + 117*X[2]^2//5000 - 97*X[2]//12500 + 19//500
M0 = [1, X[2], X[1]]
Q0 = [0.037746606722691985 -0.0038554784260313333 -0.011530128390110594;
 -0.0038554784260313333 0.023818468378020177 0.001959648016973305;
 -0.011530128390110594 0.001959648016973305 0.022831214171521733;
]
rational_SOS(P0, 1, 0, M0, Q0)
solve(n, X, P0, Q0, M0, false)
## Total Decomposition
P1 = 953*X[1]^4//10000 - 431*X[1]^3*X[2]//1000 - 241*X[1]^3//1000 + 27*X[1]^2*X[2]^2//25 + 317*X[1]^2*X[2]//5000 + 363*X[1]^2//1000 - 891*X[1]*X[2]^3//10000 - 79*X[1]*X[2]^2//250 + 79*X[1]*X[2]//125 - 217*X[1]//5000 + 569*X[2]^4//10000 + 221*X[2]^3//1000 + 317*X[2]^2//1000 - 159*X[2]//1000 + 7//20
M1 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q1 = [0.3495523076029936 -0.07934303527704722 -0.021579979052402578 -0.04213863023603353 0.23261692887611765 -0.053545899122104196;
 -0.07934303527704722 0.40161059213285416 0.08305945770446264 0.11054923950979256 -0.17120076391851793 -0.0016453766823998537;
 -0.021579979052402578 0.08305945770446264 0.4698734263057011 0.013007354256859385 0.033651069162471264 -0.12045403170228405;
 -0.04213863023603353 0.11054923950979256 0.013007354256859385 0.05722251862059571 -0.04421661347827956 0.0007616111356533264;
 0.23261692887611765 -0.17120076391851793 0.033651069162471264 -0.04421661347827956 1.0735981746211198 -0.21583271154967143;
 -0.053545899122104196 -0.0016453766823998537 -0.12045403170228405 0.0007616111356533264 -0.21583271154967143 0.0953798248900727;
]
solve(n, X, P1, Q1, M1, false)
## Multiplier-1
P2 = 77*X[1]^2//1000 - 37*X[1]*X[2]//2000 - 319*X[1]//10000 + 19*X[2]^2//100 + 61*X[2]//250 + 301//1000
M2 = [1, X[2], X[1]]
Q2 = [0.30103297658357486 0.12226220181937139 -0.015939836185244083;
 0.12226220181937139 0.18935781535874438 -0.009297513149546629;
 -0.015939836185244083 -0.009297513149546629 0.07675536154118195;
]
solve(n, X, P2, Q2, M2, false)
# second
## Multiplier-2
P3 = 99*X[1]^2//500 + 397*X[1]*X[2]//5000 - 63*X[1]//500 + 67*X[2]^2//500 - 689*X[2]//10000 + 109//1000
M3 = [1, X[2], X[1]]
Q3 = [0.10902031363944197 -0.03448376180060349 -0.06289677748679902;
 -0.03448376180060349 0.13385550887951356 0.03974304500151124;
 -0.06289677748679902 0.03974304500151124 0.19835212114510078;
]
solve(n, X, P3, Q3, M3, false)
## Total Decomposition
P4 = 253*X[1]^4//500 + 3*X[1]^3*X[2]//8 + 103*X[1]^3//250 + 101*X[1]^2*X[2]^2//250 - 291*X[1]^2*X[2]//1000 + 521*X[1]^2//1000 + 181*X[1]*X[2]^3//1000 - 63*X[1]*X[2]^2//1000 - 683*X[1]*X[2]//10000 - 21*X[1]//200 + 131*X[2]^4//1000 + 67*X[2]^3//500 + 427*X[2]^2//1000 - 359*X[2]//10000 + 59//125
M4 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q4 = [0.4720365966227974 -0.017714277768076915 -0.05225094317713128 -0.02553267395510396 -0.01263260871162427 -0.04183345443356159;
 -0.017714277768076915 0.4772890934219145 -0.021556852056233297 0.06676464419221247 0.004764034379063338 -0.11397489905053255;
 -0.05225094317713128 -0.021556852056233297 0.6053491175842424 -0.03623976337331157 -0.031745479109268365 0.2057967195767534;
 -0.02553267395510396 0.06676464419221247 -0.03623976337331157 0.1309295648765938 0.09070562013683947 -0.028168493884285786;
 -0.01263260871162427 0.004764034379063338 -0.031745479109268365 0.09070562013683947 0.4607298530424726 0.18743364193863143;
 -0.04183345443356159 -0.11397489905053255 0.2057967195767534 -0.028168493884285786 0.18743364193863143 0.5065134615929222;
]
solve(n, X, P4, Q4, M4, false)
## Multiplier-1
P5 = 19*X[1]^2//100 + 47*X[1]*X[2]//200 + 117*X[1]//10000 + 87*X[2]^2//100 - 7*X[2]//50 + 323//500
M5 = [1, X[2], X[1]]
Q5 = [0.6456998373246609 -0.06976287301527859 0.0056541871287827125;
 -0.06976287301527859 0.8695303834975368 0.11788194836532596;
 0.0056541871287827125 0.11788194836532596 0.18996408988639282;
]
solve(n, X, P5, Q5, M5, false)
# seventh
## Total Decomposition
P6 = 689*X[1]^4//2000 - 1417*X[1]^3*X[2]//20000 - 1429*X[1]^3//2500 + 431*X[1]^2*X[2]^2//625 - 4311*X[1]^2*X[2]//10000 + 6473*X[1]^2//10000 - 3573*X[1]*X[2]^3//50000 - 43*X[1]*X[2]^2//100 - 2971*X[1]*X[2]//5000 - 701*X[1]//2000 + 431*X[2]^4//1250 - 5721*X[2]^3//10000 + 809*X[2]^2//1250 - 701*X[2]//2000 + 149//125
M6 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q6 = [1.1921305701903215 -0.1757480059474964 -0.17574800594749898 -0.06108584749150772 -0.3142641907000136 -0.061085847491509894;
 -0.1757480059474964 0.7689810392596318 0.01765966119608929 -0.28594819260621057 -0.134556780148301 -0.08073942047873965;
 -0.17574800594749898 0.01765966119608929 0.7689810392596329 -0.08073942047874008 -0.13455678014830266 -0.2859481926062092;
 -0.06108584749150772 -0.28594819260621057 -0.08073942047874008 0.3446442075702661 -0.03532599598958278 0.04962918300648995;
 -0.3142641907000136 -0.134556780148301 -0.13455678014830266 -0.03532599598958278 0.5900300432940287 -0.03532599598958268;
 -0.061085847491509894 -0.08073942047873965 -0.2859481926062092 0.04962918300648995 -0.03532599598958268 0.3446442075702637;
]
solve(n, X, P6, Q6, M6, false)
## Multiplier-1
P7 = 43*X[1]^2//125 - 709*X[1]*X[2]//10000 + 117*X[1]//1000 + 43*X[2]^2//125 + 117*X[2]//1000 + 139//500
M7 = [1, X[2], X[1]]
Q7 = [0.27846602775945584 0.05869600913053812 0.05869600913053768;
 0.05869600913053812 0.34464420757026537 -0.035325995989583164;
 0.05869600913053768 -0.035325995989583164 0.34464420757026376;
]
solve(n, X, P7, Q7, M7, false)
# eighth
## Multiplier-2
P8 = 493*X[1]^2//1000 + 771*X[1]*X[2]//10000 + 187*X[1]//2500 + 519*X[2]^2//1000 - 9*X[2]//50 + 107//200
M8 = [1, X[2], X[1]]
Q8 = [0.5345693380077896 -0.0898258528777764 0.03736492410479729;
 -0.0898258528777764 0.5188239527291509 0.0384174443433336;
 0.03736492410479729 0.0384174443433336 0.49246843668870016;
]
solve(n, X, P8, Q8, M8, false)
## Total Decomposition
P9 = 8437*X[1]^4//10000 + 281*X[1]^3*X[2]//5000 - 5943*X[1]^3//10000 + 611*X[1]^2*X[2]^2//500 + 1253*X[1]^2*X[2]//1000 + 1603*X[1]^2//1000 + 3793*X[1]*X[2]^3//50000 - 4261*X[1]*X[2]^2//10000 - 7779*X[1]*X[2]//10000 + 2593*X[2]^4//5000 + 1377*X[2]^3//1000 + 2167*X[2]^2//5000 - 1323*X[2]//5000 + 2321//1000
M9 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q9 = [2.3213283991908487 -0.13324323597374993 -2.027194754846118e-05 -0.5177309404808447 -0.11254901200672368 0.12103899157759794;
 -0.13324323597374993 1.4686490688050498 -0.2774397662724766 0.6884100717352383 -0.08133379359760125 0.28273512981847543;
 -2.027194754846118e-05 -0.2774397662724766 1.3620749446640945 -0.1314521397739981 0.34408505950367096 -0.2975432622735223;
 -0.5177309404808447 0.6884100717352383 -0.1314521397739981 0.5188239527291654 0.03841744434333359 0.10214172855547123;
 -0.11254901200672368 -0.08133379359760125 0.34408505950367096 0.03841744434333359 1.0189913605905527 0.027942821719929345;
 0.12103899157759794 0.28273512981847543 -0.2975432622735223 0.10214172855547123 0.027942821719929345 0.8440071939794018;
]
solve(n, X, P9, Q9, M9, false)
## Multiplier-1
P10 = 211*X[1]^2//250 + 277*X[1]*X[2]//5000 + 249*X[1]//1000 + 73*X[2]^2//100 - 21*X[2]//125 + 371//500
M10 = [1, X[2], X[1]]
Q10 = [0.742140983276232 -0.08393963951026687 0.12446033322260815;
 -0.08393963951026687 0.730806383999936 0.027942821719929144;
 0.12446033322260815 0.027942821719929144 0.8440071939794013;
]
solve(n, X, P10, Q10, M10, false)
# first
## Multiplier-2
P11 = 169*X[1]^2//100 - 4041*X[1]*X[2]//10000 - 863*X[1]//25000 + 173*X[2]^2//100 - 587*X[2]//500 + 1569//1000
M11 = [1, X[2], X[1]]
Q11 = [1.569081150795714 -0.5870210292149608 -0.017550460913182506;
 -0.5870210292149608 1.7303165410011503 -0.20206713517687896;
 -0.017550460913182506 -0.20206713517687896 1.689669583861067;
]
solve(n, X, P11, Q11, M11, false)
## Total Decomposition
P12 = 8703*X[1]^4//5000 - 10843*X[1]^3*X[2]//25000 + 39327*X[1]^3//10000 + 17207*X[1]^2*X[2]^2//5000 + 2352*X[1]^2*X[2]//625 + 62157*X[1]^2//10000 - 40311*X[1]*X[2]^3//100000 + 40131*X[1]*X[2]^2//10000 + 8957*X[1]*X[2]//10000 - 5123*X[1]//2500 + 8641*X[2]^4//5000 + 20063*X[2]^3//5000 + 23299*X[2]^2//5000 - 5713*X[2]//2500 + 10679//1000
M12 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q12 = [10.678652328234094 -1.139476256978011 -1.0199425081670983 -0.6381945396392726 -1.234377423631929 -0.07210827165733923;
 -1.139476256978011 5.940785866810219 1.6859077738245825 2.0084537822867707 1.0558136730192045 0.7952022258952435;
 -1.0199425081670983 1.6859077738245825 6.364510519911307 0.9511510806902074 1.0893022343586503 1.9645033464061028;
 -0.6381945396392726 2.0084537822867707 0.9511510806902074 1.7303165410011467 -0.2020671351768783 0.32875290259365897;
 -1.234377423631929 1.0558136730192045 1.0893022343586503 -0.2020671351768783 2.7859748587759157 -0.21582716577020528;
 -0.07210827165733923 0.7952022258952435 1.9645033464061028 0.32875290259365897 -0.21582716577020528 1.7396235290645974;
]
solve(n, X, P12, Q12, M12, false)
## Multiplier-1
P13 = 1739*X[1]^2//1000 - 1081*X[1]*X[2]//2500 - 129*X[1]//100 + 877*X[2]^2//500 - 6337*X[2]//1000000 + 1573//1000
M13 = [1, X[2], X[1]]
Q13 = [1.5733697667416426 -0.002518418227084154 -0.6449319471907838;
 -0.002518418227084154 1.7538110801021567 -0.21582716577020697;
 -0.6449319471907838 -0.21582716577020697 1.7396235290646034;
]
solve(n, X, P13, Q13, M13, false)
# fifth
## Total Decomposition
P14 = 24427*X[1]^4//2500 - 16821*X[1]^3*X[2]//5000 - 13673*X[1]^3//1000 + 15343*X[1]^2*X[2]^2//1000 - 1749*X[1]^2*X[2]//125 + 15971*X[1]^2//1000 + 8309*X[1]*X[2]^3//2000 - 2697*X[1]*X[2]^2//200 - 5203*X[1]*X[2]//2500 - 26651*X[1]//1000 + 6871*X[2]^4//500 - 60717*X[2]^3//10000 + 24057*X[2]^2//1000 - 6733*X[2]//2000 + 4293//125
M14 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q14 = [34.34360814292611 -1.6847225776185328 -13.321032868428574 2.8780236819178557 -2.0920397128420376 -3.16895555801801;
 -1.6847225776185328 18.286684885499213 1.0477707180015714 -3.0404433089843583 -2.9992882817494406 -3.0904104061773774;
 -13.321032868428574 1.0477707180015714 22.28979390022107 -3.740564413494544 -3.904338586501364 -6.836412666860501;
 2.8780236819178557 -3.0404433089843583 -3.740564413494544 13.740876743269364 2.07768257525963 -0.19077475588205786;
 -2.0920397128420376 -2.9992882817494406 -3.904338586501364 2.07768257525963 15.734941424917482 -1.6742994081155862;
 -3.16895555801801 -3.0904104061773774 -6.836412666860501 -0.19077475588205786 -1.6742994081155862 9.771036059079925;
]
solve(n, X, P14, Q14, M14, false)
## Multiplier-1
P15 = 9717*X[1]^2//1000 - 3061*X[1]*X[2]//1000 + 5199*X[1]//1000 + 246*X[2]^2//25 + 2097*X[2]//1000 + 1477//200
M15 = [1, X[2], X[1]]
Q15 = [7.384547858428371 1.046689888403587 2.597960154559607;
 1.046689888403587 9.839268078589168 -1.5272526569881961;
 2.597960154559607 -1.5272526569881961 9.714953415726523;
]
solve(n, X, P15, Q15, M15, false)
# fourth
## Total Decomposition
P16 = 1943*X[1]^4//1000 - 549*X[1]^3*X[2]//5000 - 1373*X[1]^3//100000 + 444*X[1]^2*X[2]^2//125 - 3203*X[1]^2*X[2]//10000 + 121*X[1]^2//40 + 89*X[1]*X[2]^3//200 + 291*X[1]*X[2]^2//200 + 611*X[1]*X[2]//2000 + 1199*X[1]//1000 + 837*X[2]^4//500 + 5181*X[2]^3//10000 + 639*X[2]^2//200 + 653*X[2]//2500 + 3349//1000
M16 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q16 = [3.3494382262753963 0.12995648087845765 0.5993504844348918 0.2373585024850791 0.06794939981835628 0.1482100682853252;
 0.12995648087845765 2.719461179750498 0.0844764319958982 0.25834699640197634 0.4760819312217222 -0.07277966927473957;
 0.5993504844348918 0.0844764319958982 2.7296003911328537 0.25167118591167864 -0.08770982006644547 -0.007854965923846472;
 0.2373585024850791 0.25834699640197634 0.25167118591167864 1.6736194280113297 0.22210195233695942 0.2129135907756141;
 0.06794939981835628 0.4760819312217222 -0.08770982006644547 0.22210195233695942 3.127294566952351 -0.056247505786703046;
 0.1482100682853252 -0.07277966927473957 -0.007854965923846472 0.2129135907756141 -0.056247505786703046 1.9422969674286983;
]
solve(n, X, P16, Q16, M16, false)
## Multiplier-1
P17 = 891*X[1]^2//500 - 1831*X[1]*X[2]//10000 - 2341*X[1]//10000 + 7*X[2]^2//4 - 1913*X[2]//10000 + 1427//1000
M17 = [1, X[2], X[1]]
Q17 = [1.4268525699211243 -0.0961637366944977 -0.11656675995664134;
 -0.0961637366944977 1.7501313564628582 -0.09177994957093837;
 -0.11656675995664134 -0.09177994957093837 1.7823551666268636;
]
solve(n, X, P17, Q17, M17, false)
# sixth
## Total Decomposition
P18 = 51*X[1]^4//100 - 17*X[1]^3*X[2]//500 + 383*X[1]^3//1000 + 51*X[1]^2*X[2]^2//50 + 349*X[1]^2*X[2]//1000 + 49*X[1]^2//100 - 333*X[1]*X[2]^3//10000 + 349*X[1]*X[2]^2//1000 - 53*X[1]*X[2]//200 + 457*X[1]//1000 + 511*X[2]^4//1000 + 383*X[2]^3//1000 + 49*X[2]^2//100 + 457*X[2]//1000 + 189//200
M18 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q18 = [0.9445901290799369 0.2289339391091252 0.22893393910912538 -0.10327414564474567 -0.15267572165914414 -0.10327414564474614;
 0.2289339391091252 0.6963057773266668 0.02086408958157357 0.1914385264867471 0.10554359406723017 0.06928574894319675;
 0.22893393910912538 0.02086408958157357 0.6963057773266655 0.0692857489431962 0.10554359406723011 0.1914385264867467;
 -0.10327414564474567 0.1914385264867471 0.0692857489431962 0.5105364018617791 -0.016609183476320538 0.08429572811484184;
 -0.15267572165914414 0.10554359406723017 0.10554359406723011 -0.016609183476320538 0.8524813348140804 -0.01660918347632049;
 -0.10327414564474614 0.06928574894319675 0.1914385264867467 0.08429572811484184 -0.01660918347632049 0.5105364018617788;
]
solve(n, X, P18, Q18, M18, false)
## Multiplier-1
P19 = 51*X[1]^2//100 - 21*X[1]*X[2]//625 - 127*X[1]//1000 + 51*X[2]^2//100 - 127*X[2]//1000 + 49//100
M19 = [1, X[2], X[1]]
Q19 = [0.48978272495016795 -0.06382966810424524 -0.06382966810424517;
 -0.06382966810424524 0.5105364018617793 -0.016609183476320885;
 -0.06382966810424517 -0.016609183476320885 0.510536401861779;
]
solve(n, X, P19, Q19, M19, false)

@show SOS_time Newton_time