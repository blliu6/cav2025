include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-100


function solve(n, X, f, Q, mono,newton)
    
    Q = round.(Q, digits=18)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]



#H1
# third
## Multiplier-2
P0 = 153*X[1]^2//100000 - 69*X[1]*X[2]//12500 + 13*X[1]//5000 + 153*X[2]^2//10000 - 817*X[2]//100000 + 13//1000
M0 = [1, X[2], X[1]]
Q0 = [0.013262543484841524 -0.004161592084601685 0.0013092035549606834;
 -0.004161592084601685 0.015705744116915155 -0.002835316192863404;
 0.0013092035549606834 -0.002835316192863404 0.0016939205925080132;
]
solve(n, X, P0, Q0, M0, true)
## Total Decomposition
P1 = 83*X[1]^4//5000 - 67*X[1]^3*X[2]//5000 + 51*X[1]^3//2500 - 487*X[1]^2*X[2]^2//10000 + 169*X[1]^2*X[2]//5000 + 7*X[1]^2//100 - 129*X[1]*X[2]^3//1000000 - 73*X[1]*X[2]^2//1250 - 17*X[1]*X[2]//1000 - 723*X[1]//100000 + 73*X[2]^4//500 - 81*X[2]^3//1000 + 219*X[2]^2//1000 - 217*X[2]//10000 + 19//100
M1 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q1 = [0.1902952060257343 -0.010875310691232995 -0.003539821073234801 0.019289256189109358 0.0022980919577622085 -0.011402064921604397;
 -0.010875310691232995 0.1804660489061077 -0.010846445893736656 -0.04051069137936979 -0.0034364834789658853 0.013439220724491505;
 -0.003539821073234801 -0.010846445893736656 0.0926171763272484 -0.02578558308886307 0.0034785930078429237 0.010148025722923974;
 0.019289256189109358 -0.04051069137936979 -0.02578558308886307 0.14632233825403515 -6.43571619302208e-05 -0.036975007834103575;
 0.0022980919577622085 -0.0034364834789658853 0.0034785930078429237 -6.43571619302208e-05 0.025670740711339603 -0.006827378022079486;
 -0.011402064921604397 0.013439220724491505 0.010148025722923974 -0.036975007834103575 -0.006827378022079486 0.01642415122247743;
]
solve(n, X, P1, Q1, M1, false)
## Multiplier-1
P2 = 401*X[1]^2//100000 - 59*X[1]*X[2]//5000 + 3*X[1]//625 + 347*X[2]^2//10000 - 203*X[2]//10000 + 11//500
M2 = [1, X[2], X[1]]
Q2 = [0.021662356588614144 -0.010012425837357616 0.002368677668766231;
 -0.010012425837357616 0.03496374750220565 -0.005932774615639278;
 0.002368677668766231 -0.005932774615639278 0.0035938657304535617;
]
solve(n, X, P2, Q2, M2, false)
# second
## Multiplier-2
P3 = 9*X[1]^2//500 + 57*X[1]*X[2]//12500 + 13*X[1]//100000 + 13*X[2]^2//25000 - 39*X[2]//500000 + 3//1000
M3 = [1, X[2], X[1]]
Q3 = [0.0031099952462255993 -3.955384416919095e-05 6.761995746685083e-05;
 -3.955384416919095e-05 0.0005228145023322686 0.002286355005971811;
 6.761995746685083e-05 0.002286355005971811 0.018264591075691013;
]
solve(n, X, P3, Q3, M3, false)
## Total Decomposition
P4 = 37*X[1]^4//1250 + 57*X[1]^3*X[2]//5000 - 97*X[1]^3//50000 + 13*X[1]^2*X[2]^2//1250 + 51*X[1]^2*X[2]//5000 + 109*X[1]^2//1000 + 43*X[1]*X[2]^3//20000 + 253*X[1]*X[2]^2//100000 + 111*X[1]*X[2]//5000 - 13*X[1]//12500 + 103*X[2]^4//100000 - 209*X[2]^3//100000 + 23*X[2]^2//3125 + 749*X[2]//100000 + 13//125
M4 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q4 = [0.10400185640706576 0.0037342669856159647 -0.0005572883704906537 -0.004902311554501249 0.0012495849179175048 0.00761252512274481;
 0.0037342669856159647 0.017556146279937995 0.010109163618577038 -0.001056305901886159 0.000788414212589023 0.002970441143991622;
 -0.0005572883704906537 0.010109163618577038 0.09372381503316422 0.00046835869528968064 0.0021715388078318585 -0.00093546861428273;
 -0.004902311554501249 -0.001056305901886159 0.00046835869528968064 0.0011520971762039051 0.0012666342003671935 -0.0019492013389971353;
 0.0012495849179175048 0.000788414212589023 0.0021715388078318585 0.0012666342003671935 0.013678804550719964 0.0050721956439021025;
 0.00761252512274481 0.002970441143991622 -0.00093546861428273 -0.0019492013389971353 0.0050721956439021025 0.0298129844906853;
]
solve(n, X, P4, Q4, M4, false)
## Multiplier-1
P5 = 11*X[1]^2//1000 + 269*X[1]*X[2]//100000 + 11*X[1]//100000 + 73*X[2]^2//200000 - 17*X[2]//100000 + 3//1000
M5 = [1, X[2], X[1]]
Q5 = [0.0025102266023818882 -7.348646468258936e-05 4.69144168566105e-05;
 -7.348646468258936e-05 0.00038777437205453797 0.0014306460477737405;
 4.69144168566105e-05 0.0014306460477737405 0.011479619463818803;
]
solve(n, X, P5, Q5, M5, false)
# seventh
## Multiplier-2
P6 = 1//250
M6 = [1, X[2], X[1]]
Q6 = [0.0037496345109785246 -1.9483132649183664e-19 -2.384670370370522e-19;
 -1.9483132649183664e-19 4.4344004772474226e-05 6.953294577275208e-22;
 -2.384670370370522e-19 6.953294577275208e-22 2.3221146961842598e-05;
]
# solve(n, X, P6, Q6, M6, false)
## Total Decomposition
P7 = 197*X[1]^4//10000000 + 197*X[1]^2*X[2]^2//5000000 - 6*X[1]^2//3125 + 197*X[2]^4//10000000 - 6*X[2]^2//3125 + 197//1000
M7 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q7 = [0.19667481015163654 7.467231674243026e-18 2.569169483531903e-19 -0.0019715730809927072 -7.061018977196515e-20 -0.0019715730831305345;
 7.467231674243026e-18 0.001595025764162756 -3.4483729205217266e-19 -2.1698724108538383e-19 -4.9117729146172185e-20 1.3635537183848487e-20;
 2.569169483531903e-19 -3.4483729205217266e-19 0.0015950257645086245 -2.0281233611017341e-19 3.472839603578659e-20 2.2216342292302813e-19;
 -0.0019715730809927072 -2.1698724108538383e-19 -2.0281233611017341e-19 4.4344004868754184e-05 6.953436136226414e-22 8.009533677997455e-06;
 -7.061018977196515e-20 -4.9117729146172185e-20 3.472839603578659e-20 6.953436136226414e-22 3.0423226146204353e-05 1.0559349260253089e-21;
 -0.0019715730831305345 1.3635537183848487e-20 2.2216342292302813e-19 8.009533677997455e-06 1.0559349260253089e-21 4.434400492521542e-05;
]
solve(n, X, P7, Q7, M7, false)
## Multiplier-1
P8 = 1//250
M8 = [1, X[2], X[1]]
Q8 = [0.0037496344813792238 1.1223338214468524e-19 2.3562031210921314e-19;
 1.1223338214468524e-19 2.3221146961052987e-05 1.0559491021462774e-21;
 2.3562031210921314e-19 1.0559491021462774e-21 4.4344004710902805e-05;
]
# solve(n, X, P8, Q8, M8, true)
# eighth
## Multiplier-2
P9 = 327*X[1]^2//10000 + 79*X[1]*X[2]//10000 - 33*X[1]//2500 + 53*X[2]^2//2000 + 47*X[2]//1000 + 41//1000
M9 = [1, X[2], X[1]]
Q9 = [0.0409411406603227 0.02346233889326886 -0.006583720166980952;
 0.02346233889326886 0.026436217246658518 0.0039507547510244795;
 -0.006583720166980952 0.0039507547510244795 0.03226095007493693;
]
solve(n, X, P9, Q9, M9, true)
## Total Decomposition
P10 = 1363*X[1]^4//50000 - 1087*X[1]^3*X[2]//250000 - 4381*X[1]^3//10000 + 921*X[1]^2*X[2]^2//20000 - 1173*X[1]^2*X[2]//2500 + 1629*X[1]^2//500 + 8219*X[1]*X[2]^3//1000000 - 3831*X[1]*X[2]^2//10000 + 2339*X[1]*X[2]//5000 + 1009*X[1]//10000 + 331*X[2]^4//12500 - 253*X[2]^3//625 + 4837*X[2]^2//1000 - 799*X[2]//500 + 191//125
M10 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q10 = [1.5280129137246399 -0.798811040400397 0.05038700610766796 0.05848554435145615 -0.010457037010611226 0.00818706289016324;
 -0.798811040400397 4.72090632057212 0.24310626544858782 -0.20124542230127962 -0.2171823667293401 -0.05566293258666505;
 0.05038700610766796 0.24310626544858782 3.2424222103013314 0.02790070073426379 -0.17772329458394603 -0.21979013985706375;
 0.05848554435145615 -0.20124542230127962 0.02790070073426379 0.02643621724668867 0.003950754751000872 -0.004816317942723177;
 -0.010457037010611226 -0.2171823667293401 -0.17772329458394603 0.003950754751000872 0.055485952438180663 -0.002315512825220831;
 0.00818706289016324 -0.05566293258666505 -0.21979013985706375 -0.004816317942723177 -0.002315512825220831 0.027294563844949618;
]
solve(n, X, P10, Q10, M10, true)
## Multiplier-1
P11 = 137*X[1]^2//5000 - 483*X[1]*X[2]//100000 + 247*X[1]//10000 + 7*X[2]^2//500 + 29*X[2]//10000 + 4//125
M11 = [1, X[2], X[1]]
Q11 = [0.031655808962142214 0.0014680450353288812 0.012213567422324847;
 0.0014680450353288812 0.013592376525162321 -0.002315512825209278;
 0.012213567422324847 -0.002315512825209278 0.027294563844950045;
]
solve(n, X, P11, Q11, M11, true)
# first
## Multiplier-2
P12 = 47*X[1]^2//2000 + 81*X[1]*X[2]//20000 - 83*X[1]//20000 + 409*X[2]^2//50000 + 141*X[2]//10000 + 83//200
M12 = [1, X[2], X[1]]
Q12 = [0.4149601372623199 0.006883232280480994 -0.0020554628140735205;
 0.006883232280480994 0.008430635412019579 0.0020953911069058247;
 -0.0020554628140735205 0.0020953911069058247 0.023684025351605166;
]
solve(n, X, P12, Q12, M12, true)
## Total Decomposition
P13 = 303*X[1]^4//5000 + 391*X[1]^3*X[2]//50000 - 451*X[1]^3//100000 + 151*X[1]^2*X[2]^2//5000 + 199*X[1]^2*X[2]//10000 + 657*X[1]^2//10000 + 227*X[1]*X[2]^3//50000 - 81*X[1]*X[2]^2//20000 + 7*X[1]*X[2]//500 + 337*X[1]//50000 + 869*X[2]^4//100000 + 17*X[2]^3//1250 - 13*X[2]^2//500 - 107*X[2]//5000 + 281//1000
M13 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q13 = [0.2811764889688353 -0.010707538724356112 0.003247573693435847 -0.031227721607369658 0.0004922437576782244 -0.02276311407438024;
 -0.010707538724356112 0.036797361804849466 0.006510246996668549 0.0068832322804834815 -0.0017010289707374312 -0.0009806383483456345;
 0.003247573693435847 0.006510246996668549 0.11172923616495897 -0.0003544338433361796 0.010971538533096964 -0.0022428155310371097;
 -0.031227721607369658 0.0068832322804834815 -0.0003544338433361796 0.008430635412030022 0.002095391106906283 -0.002515565780713722;
 0.0004922437576782244 -0.0017010289707374312 0.010971538533096964 0.002095391106906283 0.03595343398682524 0.004134134040370069;
 -0.02276311407438024 -0.0009806383483456345 -0.0022428155310371097 -0.002515565780713722 0.004134134040370069 0.059907487278764375;
]
solve(n, X, P13, Q13, M13, true)
## Multiplier-1
P14 = 151*X[1]^2//2500 + 167*X[1]*X[2]//20000 - 23*X[1]//5000 + 731*X[2]^2//100000 + 201*X[2]//10000 + 19//250
M14 = [1, X[2], X[1]]
Q14 = [0.07584776123568072 0.00999090018474944 -0.0022428155310372636;
 0.00999090018474944 0.007238277073952656 0.004134134040370269;
 -0.0022428155310372636 0.004134134040370269 0.059907487278764;
]
solve(n, X, P14, Q14, M14, true)
# fifth
## Multiplier-2
P15 = X[1]^2//1000 + 53*X[1]*X[2]//125000 - 53*X[1]//100000 + 23*X[2]^2//10000 - 33*X[2]//6250 + 3//125
M15 = [1, X[2], X[1]]
Q15 = [0.02377075216771546 -0.0026062786236067154 -0.0002730757186959989;
 -0.0026062786236067154 0.0020572910184555055 0.0001907629499670373;
 -0.0002730757186959989 0.0001907629499670373 0.0011336624623569783;
]
solve(n, X, P15, Q15, M15, true)
## Total Decomposition
P16 = 11*X[1]^4//2000 + 527*X[1]^3*X[2]//1000000 - 151*X[1]^3//100000 - 21*X[1]^2*X[2]^2//1250 + 133*X[1]^2*X[2]//20000 + 703*X[1]^2//10000 + 207*X[1]*X[2]^3//100000 + 683*X[1]*X[2]^2//1000000 + 763*X[1]*X[2]//100000 - 157*X[1]//100000 + 117*X[2]^4//2500 - 69*X[2]^3//1000 + 641*X[2]^2//10000 + 19*X[2]//1250 + 131//1000
M16 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q16 = [0.13114174507230814 0.007543426849301599 -0.0007905295557239918 -0.017681362304036673 3.025865542592771e-05 0.0026672988338645805;
 0.007543426849301599 0.0995579885900383 0.003783339687759802 -0.034483872857554373 -0.0007595665114874981 0.007833849211929875;
 -0.0007905295557239918 0.003783339687759802 0.0651133868086552 0.001152144227409096 -0.004469015588154993 -0.0007493032079871191;
 -0.017681362304036673 -0.034483872857554373 0.001152144227409096 0.04721441884805817 0.0010327218638516826 -0.012721871122475406;
 3.025865542592771e-05 -0.0007595665114874981 -0.004469015588154993 0.0010327218638516826 0.008375015537149252 0.000259554457802931;
 0.0026672988338645805 0.007833849211929875 -0.0007493032079871191 -0.012721871122475406 0.000259554457802931 0.005989709371527996;
]
solve(n, X, P16, Q16, M16, true)
## Multiplier-1
P17 = 411*X[1]^2//100000 + 883*X[1]*X[2]//1000000 - 23*X[1]//25000 + 63*X[2]^2//25000 - 37*X[2]//5000 + 27//1000
M17 = [1, X[2], X[1]]
Q17 = [0.02690986534322079 -0.0036778964660415196 -0.0004474727634492738;
 -0.0036778964660415196 0.00258351727568273 0.0004527977880748255;
 -0.0004474727634492738 0.0004527977880748255 0.0035968478095461257;
]
solve(n, X, P17, Q17, M17, true)
# fourth
## Multiplier-2
P18 = X[1]^2//200 + 31*X[1]*X[2]//10000000 + X[1]//1000 + 3*X[2]^2//10000000 + X[2]//5000 + 17//500
M18 = [1, X[2], X[1]]
Q18 = [0.03432130730432156 0.00011364809302648221 0.0005220005244232926;
 0.00011364809302648221 0.00023341867043853387 9.94846943768129e-05;
 0.0005220005244232926 9.94846943768129e-05 0.004801067709626078;
]
solve(n, X, P18, Q18, M18, true)
## Total Decomposition
P19 = 127*X[1]^4//5000 + 19*X[1]^3*X[2]//2500 - 363*X[1]^3//500000 - 387*X[1]^2*X[2]^2//50000 + 149*X[1]^2*X[2]//10000 + 111*X[1]^2//1250 - 97*X[1]*X[2]^3//50000 + 83*X[1]*X[2]^2//25000 - 43*X[1]*X[2]//100000 - 89*X[1]//125000 + 179*X[2]^4//100000 - 381*X[2]^3//100000 + 153*X[2]^2//10000 + 619*X[2]//100000 + 119//1000
M19 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q19 = [0.11923229919588957 0.003066703859742801 -0.0003932124593405298 -0.004892981891467531 0.0016416958151630409 0.008873261367049317;
 0.003066703859742801 0.02511912135600945 -0.0018945363554977136 -0.0019148954359846182 0.0013695851906856823 0.006645634475869641;
 -0.0003932124593405298 -0.0018945363554977136 0.07145100515635833 0.00029955092798466854 0.0008489434855659424 -0.0003982422537805001;
 -0.004892981891467531 -0.0019148954359846182 0.00029955092798466854 0.001770988469675141 -0.0009612541492639331 -0.0055928918681805335;
 0.0016416958151630409 0.0013695851906856823 0.0008489434855659424 -0.0009612541492639331 0.003173625173749977 0.003686382237492229;
 0.008873261367049317 0.006645634475869641 -0.0003982422537805001 -0.0055928918681805335 0.003686382237492229 0.025370105336983414;
]
solve(n, X, P19, Q19, M19, true)
## Multiplier-1
P20 = X[1]^2//500 - 9*X[1]*X[2]//2000000 + 49*X[1]//100000 + 11*X[2]^2//10000000 - 23*X[2]//100000 + 13//1000
M20 = [1, X[2], X[1]]
Q20 = [0.013466087674573295 -0.00012703875989883925 0.0002553280265793791;
 -0.00012703875989883925 0.00024335612442272247 -4.6909870833845906e-05;
 0.0002553280265793791 -4.6909870833845906e-05 0.0024735167911882267;
]
solve(n, X, P20, Q20, M20, true)
# sixth
## Multiplier-2
P21 = 1//250
M21 = [1, X[2], X[1]]
Q21 = [0.004125193386242496 -5.141285683716158e-19 -2.293850305364404e-19;
 -5.141285683716158e-19 4.5565418025627224e-05 -1.8809599808546737e-20;
 -2.293850305364404e-19 -1.8809599808546737e-20 2.419633392870195e-05;
]
# solve(n, X, P21, Q21, M21, true)
## Total Decomposition
P22 = 19*X[1]^4//1000000 + 19*X[1]^2*X[2]^2//500000 - 89*X[1]^2//50000 + 19*X[2]^4//1000000 - 89*X[2]^2//50000 + 19//100
M22 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q22 = [0.19042095706088338 2.2256591893370966e-18 5.72594473900429e-19 -0.0019365148719387123 8.229535540835057e-20 -0.0019365148687107785;
 2.2256591893370966e-18 0.0017022250881669183 3.6544637350293156e-18 -5.083627349014753e-19 -8.17174384901907e-20 3.5933585899781575e-19;
 5.72594473900429e-19 3.6544637350293156e-18 0.0017022250895484614 -1.3158764084798694e-19 2.406227671487024e-19 1.710122982120862e-19;
 -0.0019365148719387123 -5.083627349014753e-19 -1.3158764084798694e-19 4.556541798977549e-05 -1.880958169468408e-20 7.726314327216985e-06;
 8.229535540835057e-20 -8.17174384901907e-20 2.406227671487024e-19 -1.880958169468408e-20 3.294003870613251e-05 -1.4672942020724746e-20;
 -0.0019365148687107785 3.5933585899781575e-19 1.710122982120862e-19 7.726314327216985e-06 -1.4672942020724746e-20 4.556541793796776e-05;
]

solve(n, X, P22, Q22, M22, true)
## Multiplier-1
P23 = 1//250
M23 = [1, X[2], X[1]]
Q23 = [0.004125193357273524 4.795398954109733e-19 2.230404934755986e-19;
 4.795398954109733e-19 2.4196333900887215e-05 -1.467292391623221e-20;
 2.230404934755986e-19 -1.467292391623221e-20 4.556541786263685e-05;
]
# solve(n, X, P23, Q23, M23, true)