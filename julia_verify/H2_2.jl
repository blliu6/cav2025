include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-6
tol = 1e-50


function solve(n, X, f, Q, mono,newton)
    
    # Q = round.(Q, digits=1)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]

#H2
# third
## Multiplier-2
P0 = 197*X[1]^2//500 - 59*X[1]*X[2]//625 + 251*X[1]//5000 + 421*X[2]^2//1000 + 3*X[2]//10 + 33//100
M0 = [1, X[2], X[1]]
Q0 = [0.33041217593604877 0.14999248272906338 0.024954626083529455;
 0.14999248272906338 0.4214849208221174 -0.04720878854895214;
 0.024954626083529455 -0.04720878854895214 0.3933339938791633;
]
solve(n, X, P0, Q0, M0, true)
## Total Decomposition
P1 = 1493*X[1]^4//25000 - 911*X[1]^3*X[2]//5000 - 2107*X[1]^3//5000 + 3167*X[1]^2*X[2]^2//10000 - 1519*X[1]^2*X[2]//5000 + 173*X[1]^2//100 + 6663*X[1]*X[2]^3//10000 - 1719*X[1]*X[2]^2//5000 + 2251*X[1]*X[2]//2500 - 827*X[1]//500 + 299*X[2]^4//250 - 8083*X[2]^3//10000 + 1521*X[2]^2//500 - 1353*X[2]//1000 + 2469//1000
M1 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q1 = [2.4689984635014253 -0.6763347266130392 -0.8262820014601963 0.8477202506484699 0.20459615612318416 0.02438221424738041;
 -0.6763347266130392 1.3485769293010281 0.24549384241356997 -0.40428951013614933 -0.0671274767564595 -0.031578190909697774;
 -0.8262820014601963 0.24549384241356997 1.6801979453894367 -0.10461484997506967 -0.11994601254974759 -0.21073596784218285;
 0.8477202506484699 -0.40428951013614933 -0.10461484997506967 1.1959808621227714 0.3334952372865437 -0.09787002671682017;
 0.20459615612318416 -0.0671274767564595 -0.11994601254974759 0.3334952372865437 0.5129917446064539 -0.09130366405516434;
 0.02438221424738041 -0.031578190909697774 -0.21073596784218285 -0.09787002671682017 -0.09130366405516434 0.05960962526273716;
]
solve(n, X, P1, Q1, M1, true)
## Multiplier-1
P2 = 249*X[1]^2//5000 - 127*X[1]*X[2]//10000 + 273*X[1]//5000 + 219*X[2]^2//2500 + 199*X[2]//5000 + 13//250
M2 = [1, X[2], X[1]]
Q2 = [0.05247911670826477 0.020124036076763715 0.02754763870445537;
 0.020124036076763715 0.08794573872683739 -0.006291403041337739;
 0.02754763870445537 -0.006291403041337739 0.05047813460236929;
]
solve(n, X, P2, Q2, M2, true)
# second
## Multiplier-2
P3 = 497*X[1]^2//500 - 183*X[1]*X[2]//2000 + 651*X[1]//10000 + 21*X[2]^2//20 + 437*X[2]//1000 + 189//250
M3 = [1, X[2], X[1]]
Q3 = [0.7560090766384379 0.21853421348025182 0.032186472602195794;
 0.21853421348025182 1.047134810119999 -0.04577908526827549;
 0.032186472602195794 -0.04577908526827549 0.9941413188720266;
]
solve(n, X, P3, Q3, M3, true)
## Total Decomposition
P4 = 3511*X[1]^4//10000 + 2681*X[1]^3*X[2]//10000 - 2111*X[1]^3//2500 + 1029*X[1]^2*X[2]^2//1000 - 1763*X[1]^2*X[2]//2500 + 1131*X[1]^2//500 - 4381*X[1]*X[2]^3//100000 - 1821*X[1]*X[2]^2//2500 - 1077*X[1]*X[2]//5000 - 1119*X[1]//5000 + 1033*X[2]^4//1000 - 6397*X[2]^3//10000 + 3227*X[2]^2//1000 - 6289*X[2]//10000 + 533//200
M4 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q4 = [2.664741468826047 -0.31316408200447027 -0.1115003681518091 0.691921379197503 -0.05656355520712557 0.15784988329437424;
 -0.31316408200447027 1.8409480660645514 -0.05181064748197086 -0.3199529269703056 -0.21017482709131488 -0.059640102255889574;
 -0.1115003681518091 -0.05181064748197086 1.9474412184771843 -0.15458875337115435 -0.2934567265143628 -0.4232046880095601;
 0.691921379197503 -0.3199529269703056 -0.15458875337115435 1.0324823596048989 -0.02178217407316743 0.04205746373593971;
 -0.05656355520712557 -0.21017482709131488 -0.2934567265143628 -0.02178217407316743 0.9458901574686178 0.13453753514775169;
 0.15784988329437424 -0.059640102255889574 -0.4232046880095601 0.04205746373593971 0.13453753514775169 0.35168831979184384;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-1
P5 = 157*X[1]^2//2000 + 469*X[1]*X[2]//50000 + 21*X[1]//1000 + 81*X[2]^2//1000 + 2*X[2]//125 + 41//500
M5 = [1, X[2], X[1]]
Q5 = [0.08172195644114753 0.007831967986735798 0.010458936560456471;
 0.007831967986735798 0.08054077919389926 0.0046400329838190285;
 0.010458936560456471 0.0046400329838190285 0.07827961633573274;
]
solve(n, X, P5, Q5, M5, true)
# seventh
## Multiplier-2
P6 = 117*X[1]^2//500 - 121*X[1]*X[2]//2500 - 43*X[1]//2500 + 141*X[2]^2//500 + 7*X[2]//40 + 41//200
M6 = [1, X[2], X[1]]
Q6 = [0.20497337255485984 0.0877442915439625 -0.008577553652161509;
 0.0877442915439625 0.28111197427336 -0.024024836843873527;
 -0.008577553652161509 -0.024024836843873527 0.234328580553297;
]
solve(n, X, P6, Q6, M6, true)
## Total Decomposition
P7 = 2429*X[1]^4//500000 - 259*X[1]^3*X[2]//20000 - 3121*X[1]^3//50000 + 1347*X[1]^2*X[2]^2//5000 - 1833*X[1]^2*X[2]//5000 + 967*X[1]^2//2000 - 959*X[1]*X[2]^3//20000 - 3213*X[1]*X[2]^2//10000 - 1939*X[1]*X[2]//5000 - 299*X[1]//1250 + 2809*X[2]^4//10000 - 2217*X[2]^3//5000 + 5*X[2]^2//4 - 3557*X[2]//10000 + 1617//1000
M7 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q7 = [1.6169369687365365 -0.17807879204830912 -0.12008392334035382 0.2540050776846194 -0.22100963260610237 0.015531679906518842;
 -0.17807879204830912 0.7427563131672545 0.027928983396656858 -0.2214788841171782 -0.0784185694420631 0.0006882933752896778;
 -0.12008392334035382 0.027928983396656858 0.45079978207003873 -0.0825293934331582 -0.18344623898597703 -0.031034923805006713;
 0.2540050776846194 -0.2214788841171782 -0.0825293934331582 0.28111197427336043 -0.024024836843871897 0.008035182156747998;
 -0.22100963260610237 -0.0784185694420631 -0.18344623898597703 -0.024024836843871897 0.2524623914773381 -0.006401075784126145;
 0.015531679906518842 0.0006882933752896778 -0.031034923805006713 0.008035182156747998 -0.006401075784126145 0.004961855238870366;
]
solve(n, X, P7, Q7, M7, true)
## Multiplier-1
P8 = 273*X[1]^2//50000 - 8*X[1]*X[2]//625 - 261*X[1]//100000 + 343*X[2]^2//10000 - 377*X[2]//100000 + 3//250
M8 = [1, X[2], X[1]]
Q8 = [0.01155817313599159 -0.0018094135665445274 -0.001263807333838671;
 -0.0018094135665445274 0.03420417773011353 -0.0064010757841348855;
 -0.001263807333838671 -0.0064010757841348855 0.0049618552374081654;
]
solve(n, X, P8, Q8, M8, true)
# eighth
## Total Decomposition
P9 = 5661*X[1]^4//5000 + 21073*X[1]^3*X[2]//100000 - 17573*X[1]^3//2000 + 9029*X[1]^2*X[2]^2//5000 - 49163*X[1]^2*X[2]//10000 + 8213*X[1]^2//500 + 2593*X[1]*X[2]^3//12500 - 27613*X[1]*X[2]^2//5000 + 5341*X[1]*X[2]//2500 + 39431*X[1]//5000 + 67377*X[2]^4//100000 - 4389*X[2]^3//2500 + 16561*X[2]^2//1000 + 1233*X[2]//500 + 1454//125
M9 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q9 = [11.631678846832255 1.2336127972700996 3.9438277871498437 0.8050067046127702 -1.39090924449672 -1.3162230513461564;
 1.2336127972700996 14.956658451575333 2.462139425460046 -0.8806351303190942 -2.638534794574653 -0.8155712255227204;
 3.9438277871498437 2.462139425460046 19.054776362313792 -0.1274440751482546 -1.6394382431769847 -4.391113147409215;
 0.8050067046127702 -0.8806351303190942 -0.1274440751482546 0.6749542145034265 0.10469883166285944 -0.03397319224363624;
 -1.39090924449672 -2.638534794574653 -1.6394382431769847 0.10469883166285944 1.8741443568968956 0.10469881917838912;
 -1.3162230513461564 -0.8155712255227204 -4.391113147409215 -0.03397319224363624 0.10469881917838912 1.1312437070932904;
]
solve(n, X, P9, Q9, M9, true)
## Multiplier-1
P10 = 113*X[1]^2//100 + 209*X[1]*X[2]//1000 + 417*X[1]//500 + 27*X[2]^2//40 + 263*X[2]//1000 + 743//1000
M10 = [1, X[2], X[1]]
Q10 = [0.7428060831961161 0.1317960496187515 0.41667259250929023;
 0.1317960496187515 0.6749541340382981 0.10469881917998224;
 0.41667259250929023 0.10469881917998224 1.1312437071117174;
]
solve(n, X, P10, Q10, M10, true)
# first
## Multiplier-2
P11 = 419*X[1]^2//1000 - 27*X[1]*X[2]//2500 + 213*X[1]//5000 + 239*X[2]^2//500 + 11*X[2]//100 + 333//1000
M11 = [1, X[2], X[1]]
Q11 = [0.3331385101239207 0.054940616303218344 0.021214041291779166;
 0.054940616303218344 0.47771154954183453 -0.005524409753091166;
 0.021214041291779166 -0.005524409753091166 0.41890503020718933;
]
solve(n, X, P11, Q11, M11, true)
## Total Decomposition
P12 = 363*X[1]^4//10000 - 2789*X[1]^3*X[2]//500000 - 959*X[1]^3//2500 + 2303*X[1]^2*X[2]^2//5000 - 2627*X[1]^2*X[2]//10000 + 239*X[1]^2//200 - 1077*X[1]*X[2]^3//100000 - 2007*X[1]*X[2]^2//5000 + 4077*X[1]*X[2]//100000 - 1499*X[1]//200000 + 4777*X[2]^4//10000 - 2489*X[2]^3//10000 + 299*X[2]^2//200 - 108*X[2]//625 + 1253//1000
M12 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q12 = [1.2529281946501616 -0.08641651065785479 -0.00387857388008734 0.3123029038969961 -0.05768830600975106 -0.02556234285394959;
 -0.08641651065785479 0.8710114559192585 0.07770023219712291 -0.12420121194052013 -0.09915914019799157 -0.01241844293067613;
 -0.00387857388008734 0.07770023219712291 1.2451941515295806 -0.10219446923382548 -0.11963756293310075 -0.1914285036916554;
 0.3123029038969961 -0.12420121194052013 -0.10219446923382548 0.47771154954183226 -0.00552440975309131 0.00852325581692418;
 -0.05768830600975106 -0.09915914019799157 -0.11963756293310075 -0.00552440975309131 0.44307869276214334 -0.0024820960313047345;
 -0.02556234285394959 -0.01241844293067613 -0.1914285036916554 0.00852325581692418 -0.0024820960313047345 0.03616297276442886;
]
solve(n, X, P12, Q12, M12, true)
## Multiplier-1
P13 = 73*X[1]^2//2000 - 247*X[1]*X[2]//50000 + 3*X[1]//200 + 41*X[2]^2//1000 - 23*X[2]//5000 + 41//1000
M13 = [1, X[2], X[1]]
Q13 = [0.040761403779007874 -0.002269678714878258 0.007467804940395732;
 -0.002269678714878258 0.04122018174733414 -0.002482096031304996;
 0.007467804940395732 -0.002482096031304996 0.036162972764383905;
]
solve(n, X, P13, Q13, M13, true)
# fifth
## Multiplier-2
P14 = 153*X[1]^2//500 - 327*X[1]*X[2]//10000 - 7*X[1]//1000 + 119*X[2]^2//500 + 131*X[2]//1000 + 219//1000
M14 = [1, X[2], X[1]]
Q14 = [0.21900992893167254 0.06532082097585575 -0.0035384558795406424;
 0.06532082097585575 0.238669978653744 -0.016495329213710032;
 -0.0035384558795406424 -0.016495329213710032 0.3060953752068231;
]
solve(n, X, P14, Q14, M14, true)
## Total Decomposition
P15 = 59*X[1]^4//2000 - 979*X[1]^3*X[2]//10000 - 187*X[1]^3//1000 + 157*X[1]^2*X[2]^2//1000 - 39*X[1]^2*X[2]//400 + 349*X[1]^2//500 + 28*X[1]*X[2]^3//125 - 153*X[1]*X[2]^2//5000 - X[1]*X[2]//40 - 423*X[1]//1000 + 601*X[2]^4//1000 - 127*X[2]^3//500 + 5*X[2]^2//4 - 247*X[2]//1000 + 183//200
M15 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q15 = [0.9149970930592592 -0.12365671487395115 -0.21113456505812525 0.3195956938757772 0.010689345807079293 0.00031099345397384384;
 -0.12365671487395115 0.6079189665799436 -0.023631152331640884 -0.12725470546198134 -0.004204919070882605 -0.006548308427228174;
 -0.21113456505812525 -0.023631152331640884 0.6979203807874839 -0.010816977814487714 -0.04213003137898929 -0.09381075687256446;
 0.3195956938757772 -0.12725470546198134 -0.010816977814487714 0.6012136148624002 0.1116335526186848 -0.04905664786926303;
 0.010689345807079293 -0.004204919070882605 -0.04213003137898929 0.1116335526186848 0.2556401183052022 -0.049031582889368326;
 0.00031099345397384384 -0.006548308427228174 -0.09381075687256446 -0.04905664786926303 -0.049031582889368326 0.02924704970439343;
]
solve(n, X, P15, Q15, M15, true)
## Multiplier-1
P16 = 241*X[1]^2//10000 - 63*X[1]*X[2]//20000 + 61*X[1]//2500 + X[2]^2//25 + 29*X[2]//5000 + 3//100
M16 = [1, X[2], X[1]]
Q16 = [0.030053778403149 0.0029159189713052216 0.012190251015889393;
 0.0029159189713052216 0.0405365666954959 -0.001607780549032875;
 0.012190251015889393 -0.001607780549032875 0.023867554799746397;
]
solve(n, X, P16, Q16, M16, true)
# fourth
## Multiplier-2
P17 = 1027*X[1]^2//1000 - 99*X[1]*X[2]//500 - 103*X[1]//1250 + 29*X[2]^2//25 + 219*X[2]//250 + 117//125
M17 = [1, X[2], X[1]]
Q17 = [0.9362919581178394 0.4385431793572018 -0.04105887769647001;
 0.4385431793572018 1.1629666900205726 -0.09844742149159634;
 -0.04105887769647001 -0.09844742149159634 1.027035958309094;
]
solve(n, X, P17, Q17, M17, true)
## Total Decomposition
P18 = 4661*X[1]^4//10000 + 3873*X[1]^3*X[2]//10000 - 391*X[1]^3//400 + 119*X[1]^2*X[2]^2//100 - 36*X[1]^2*X[2]//25 + 943*X[1]^2//250 - 3719*X[1]*X[2]^3//50000 - 287*X[1]*X[2]^2//250 - 313*X[1]*X[2]//2500 - 1321*X[1]//10000 + 1121*X[2]^4//1000 - 321*X[2]^3//250 + 4197*X[2]^2//1000 - 9513*X[2]//10000 + 1101//250
M18 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q18 = [4.404372836034804 -0.4767949430650481 -0.06721547843693157 0.797355799973246 -0.07585615576754126 0.40658404731762765;
 -0.4767949430650481 2.602808399303108 0.013484274058164762 -0.6436910714052743 -0.35395782417446403 -0.14238202964753408;
 -0.06721547843693157 0.013484274058164762 2.960942652622044 -0.22076972658158378 -0.5775389049873918 -0.4899361125376723;
 0.797355799973246 -0.6436910714052743 -0.22076972658158378 1.1213242691095928 -0.037336524878316686 0.03203241706803191;
 -0.07585615576754126 -0.35395782417446403 -0.5775389049873918 -0.037336524878316686 1.1259924534204164 0.19334797613357627;
 0.40658404731762765 -0.14238202964753408 -0.4899361125376723 0.03203241706803191 0.19334797613357627 0.46607051061844884;
]
solve(n, X, P18, Q18, M18, true)
## Multiplier-1
P19 = 903*X[1]^2//10000 - 577*X[1]*X[2]//100000 + 127*X[1]//5000 + 121*X[2]^2//1000 + X[2]//625 + 37//500
M19 = [1, X[2], X[1]]
Q19 = [0.07409768416120616 0.0008346353261889131 0.012713770224748826;
 0.0008346353261889131 0.1206092637277467 -0.002889791558505594;
 0.012713770224748826 -0.002889791558505594 0.09047405250104207;
]
solve(n, X, P19, Q19, M19, true)
# sixth
## Multiplier-2
P20 = 31*X[1]^2//125 - 67*X[1]*X[2]//2000 - 221*X[1]//50000 + 273*X[2]^2//1000 + 163*X[2]//1000 + 201//1000
M20 = [1, X[2], X[1]]
Q20 = [0.20149566789913329 0.08164153451951803 -0.002168506765446464;
 0.08164153451951803 0.2731623812913341 -0.016784202361552487;
 -0.002168506765446464 -0.016784202361552487 0.2479645926202394;
]
solve(n, X, P20, Q20, M20, true)
## Total Decomposition
P21 = 913*X[1]^4//250000 - 257*X[1]^3*X[2]//25000 - 39*X[1]^3//800 + 174*X[1]^2*X[2]^2//625 - 3703*X[1]^2*X[2]//10000 + 2093*X[1]^2//5000 - 3403*X[1]*X[2]^3//100000 - 3031*X[1]*X[2]^2//10000 - 1647*X[1]*X[2]//5000 - 1317*X[1]//5000 + 2733*X[2]^4//10000 - 759*X[2]^3//2000 + 561*X[2]^2//500 - 1643*X[2]//5000 + 163//125
M21 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q21 = [1.303971981654858 -0.16439909449014967 -0.13175476654270687 0.2319828516822334 -0.1821208485411399 0.015981241042362867;
 -0.16439909449014967 0.6581251864932393 0.018164941178353343 -0.19015503326919928 -0.07127199411123683 0.0012319606982355235;
 -0.13175476654270687 0.018164941178353343 0.3869100292923314 -0.08032678236410848 -0.18619314745205454 -0.024419487866461514;
 0.2319828516822334 -0.19015503326919928 -0.08032678236410848 0.27316238129134507 -0.01678420236155006 0.0072098368771707135;
 -0.1821208485411399 -0.07127199411123683 -0.18619314745205454 -0.01678420236155006 0.2640167242941879 -0.005263465168892628;
 0.015981241042362867 0.0012319606982355235 -0.024419487866461514 0.0072098368771707135 -0.005263465168892628 0.003800555440454817;
]
solve(n, X, P21, Q21, M21, true)
## Multiplier-1
P22 = 83*X[1]^2//20000 - 13*X[1]*X[2]//1250 - 161*X[1]//50000 + 151*X[2]^2//5000 - 281*X[2]//100000 + 13//1000
M22 = [1, X[2], X[1]]
Q22 = [0.012981739228975726 -0.001398000838160968 -0.0016161727166474767;
 -0.001398000838160968 0.03047180834152911 -0.005263465168932485;
 -0.0016161727166474767 -0.005263465168932485 0.0038005554387096083;
]
solve(n, X, P22, Q22, M22, true)

@show SOS_time Newton_time