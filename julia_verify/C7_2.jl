include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50



SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 3
@Symbolics.variables X[1:n]
#C7
# init
## Total Decomposition
P0 = 5063*X[1]^4//1000000 + 651*X[1]^3*X[2]//500000 - 6211*X[1]^3*X[3]//10000000 + 313*X[1]^3//2000 + 1021*X[1]^2*X[2]^2//100000 - 2597*X[1]^2*X[2]*X[3]//10000000 + 869*X[1]^2*X[2]//5000 + 509*X[1]^2*X[3]^2//50000 - 1519*X[1]^2*X[3]//10000 + 2777*X[1]^2//1000 + 1953*X[1]*X[2]^3//5000000 - 1623*X[1]*X[2]^2*X[3]//2000000 + 1659*X[1]*X[2]^2//10000 + 8859*X[1]*X[2]*X[3]^2//10000000 - 5657*X[1]*X[2]*X[3]//100000 + 1537*X[1]*X[2]//2500 - 2561*X[1]*X[3]^3//5000000 + 1587*X[1]*X[3]^2//10000 - 4533*X[1]*X[3]//10000 - 121*X[1]//500 + 5219*X[2]^4//1000000 - 7247*X[2]^3*X[3]//10000000 + 1433*X[2]^3//10000 + 4861*X[2]^2*X[3]^2//500000 - 57*X[2]^2*X[3]//400 + 2881*X[2]^2//1000 - 1007*X[2]*X[3]^3//2500000 + 1571*X[2]*X[3]^2//10000 - 793*X[2]*X[3]//2000 - 79*X[2]//800 + 27*X[3]^4//5000 - 311*X[3]^3//2500 + 567*X[3]^2//200 + 429*X[3]//2000 + 1703//1000
M0 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q0 = [1.702652268787968 0.10710036453931603 -0.04978988064157352 -0.12142407101836382 0.0005890757384408769 0.008399426268105163 0.01037805187340726 0.0010934186708886563 -0.009577893386296922 -0.0018786925288730419;
 0.10710036453931603 2.8351058769931035 -0.20745143273660288 -0.23711008765167838 -0.06077640565885525 0.07464780231338587 0.07718356901622639 -0.003852756679728164 -0.00865364770780144 -0.009829927928977328;
 -0.04978988064157352 -0.20745143273660288 2.877134329630654 0.31893697227442164 0.0038640039122899935 -0.06731582310041873 -0.01184954981114586 0.07144736326865994 0.07738445290601766 0.011726382387637695;
 -0.12142407101836382 -0.23711008765167838 0.31893697227442164 2.780416938340495 0.0031782001739565327 -0.008835425366780673 -0.06855882740656367 0.00397733835361256 0.07556678656578625 0.07764079916130179;
 0.0005890757384408769 -0.06077640565885525 0.0038640039122899935 0.0031782001739565327 0.0048713283749449495 -0.00032604646942101766 -0.0003948038301370357 -0.0004929894375681544 0.000767621603952707 -0.00035901078624363454;
 0.008399426268105163 0.07464780231338587 -0.06731582310041873 -0.008835425366780673 -0.00032604646942101766 0.010803581153735888 -0.0004302630085316624 -0.0003260464725277072 0.0003881121036811471 -0.0009005850435511334;
 0.01037805187340726 0.07718356901622639 -0.01184954981114586 -0.06855882740656367 -0.0003948038301370357 -0.0004302630085316624 0.010953720858084305 -0.0007829159325171703 0.0005745385757349585 -0.00039480382303372315;
 0.0010934186708886563 -0.003852756679728164 0.07144736326865994 0.00397733835361256 -0.0004929894375681544 -0.0003260464725277072 -0.0007829159325171703 0.0049462744990739944 0.0003373585907214239 -0.00019085630902065904;
 -0.009577893386296922 -0.00865364770780144 0.07738445290601766 0.07556678656578625 0.000767621603952707 0.0003881121036811471 0.0005745385757349585 0.0003373585907214239 0.010692358026921117 0.0003373585925486512;
 -0.0018786925288730419 -0.009829927928977328 0.011726382387637695 0.07764079916130179 -0.00035901078624363454 -0.0009005850435511334 -0.00039480382303372315 -0.00019085630902065904 0.0003373585925486512 0.005364371510205171;
]
solve(n, X, P0, Q0, M0, true)
## Multiplier-1
P1 = 51*X[1]^2//10000 + 683*X[1]*X[2]//1000000 - 81*X[1]*X[3]//100000 - X[1]//4000 + 101*X[2]^2//20000 - 133*X[2]*X[3]//200000 - 487*X[2]//1000000 + X[3]^2//200 + 21*X[3]//100000 + 1//500
M1 = [1, X[3], X[2], X[1]]
Q1 = [0.0022618422836549763 0.00011519148031876432 -0.00027360825508480517 -0.000142579043190689;
 0.00011519148031876432 0.004871328375282928 -0.0003260464687520683 -0.000394803826971363;
 -0.00027360825508480517 -0.0003260464687520683 0.004946274503798392 0.0003373585872663606;
 -0.000142579043190689 -0.000394803826971363 0.0003373585872663606 0.005364371510209345;
]
solve(n, X, P1, Q1, M1, true)
# unsafe
## Total Decomposition
P2 = 183*X[1]^4//31250 + 1257*X[1]^3*X[2]//1000000 - 2221*X[1]^3*X[3]//10000000 + 1881*X[1]^3//10000 + 147*X[1]^2*X[2]^2//12500 - 1043*X[1]^2*X[2]*X[3]//2500000 + 221*X[1]^2*X[2]//1000 + 1073*X[1]^2*X[3]^2//100000 - 3471*X[1]^2*X[3]//100000 + 761*X[1]^2//250 + 1979*X[1]*X[2]^3//1000000 - 3621*X[1]*X[2]^2*X[3]//10000000 + 2421*X[1]*X[2]^2//10000 + 23*X[1]*X[2]*X[3]^2//12500 - 3131*X[1]*X[2]*X[3]//100000 + 2717*X[1]*X[2]//5000 - 71*X[1]*X[3]^3//250000 + 1743*X[1]*X[3]^2//10000 - 549*X[1]*X[3]//5000 - 449*X[1]//2500 + 1421*X[2]^4//250000 - 2587*X[2]^3*X[3]//10000000 + 427*X[2]^3//2500 + 109*X[2]^2*X[3]^2//10000 - 73*X[2]^2*X[3]//2000 + 71*X[2]^2//25 - 291*X[2]*X[3]^3//1000000 + 37*X[2]*X[3]^2//250 - 4949*X[2]*X[3]//50000 - 113*X[2]//400 + 5081*X[3]^4//1000000 - 1241*X[3]^3//50000 + 2481*X[3]^2//1000 - 2069*X[3]//100000 + 321//250
M2 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q2 = [1.2836944160911177 -0.010352043100029264 -0.1414048449960428 -0.0894914280377504 0.0041124971315373016 0.0016516123217448556 0.0013184354944772967 -0.003286776518244948 -0.014616171273461948 -0.0017756832285663715;
 -0.010352043100029264 2.4734171445211435 -0.049642662023618396 -0.05735749214157277 -0.012713132889066002 0.0740066108183026 0.08334844311340339 -0.00191895940950684 -0.0037811565134642637 -0.0010538629448691257;
 -0.1414048449960428 -0.049642662023618396 2.8477210843422567 0.2848040052635616 0.0010517547207936771 -0.01716749579661813 -0.003952180591934567 0.08563126180751394 0.1072657152813801 0.0060572163638807535;
 -0.0894914280377504 -0.05735749214157277 0.2848040052635616 3.0459322996789755 0.0017241952022860102 -0.005660199177869568 -0.017576866737355822 0.014811660518262748 0.10381939873831794 0.09272801263129413;
 0.0041124971315373016 -0.012713132889066002 0.0010517547207936771 0.0017241952022860102 0.00514029878456253 -0.00015238091953278385 -0.000140937021319997 -0.0006806817662214153 0.0014173045608713982 -0.0006572336189856688;
 0.0016516123217448556 0.0740066108183026 -0.01716749579661813 -0.005660199177869568 -0.00015238091953278385 0.012423670764989377 -0.0005617458044876345 -0.00015238090282607928 8.336731670655642e-05 -0.0002013649515067174;
 0.0013184354944772967 0.08334844311340339 -0.003952180591934567 -0.017576866737355822 -0.000140937021319997 -0.0005617458044876345 0.012101734286967739 -0.000224304322038316 4.898404869991666e-05 -0.0001409370047282053;
 -0.003286776518244948 -0.00191895940950684 0.08563126180751394 0.014811660518262748 -0.0006806817662214153 -0.00015238090282607928 -0.000224304322038316 0.00592200856538964 0.0008555586488561912 -0.00022079465069327274;
 -0.014616171273461948 -0.0037811565134642637 0.1072657152813801 0.10381939873831794 0.0014173045608713982 8.336731670655642e-05 4.898404869991666e-05 0.0008555586488561912 0.01201056604286901 0.0008555586561326094;
 -0.0017756832285663715 -0.0010538629448691257 0.0060572163638807535 0.09272801263129413 -0.0006572336189856688 -0.0002013649515067174 -0.0001409370047282053 -0.00022079465069327274 0.0008555586561326094 0.005646968403728409;
]
solve(n, X, P2, Q2, M2, true)
## Multiplier-1
P3 = 517*X[1]^2//100000 + 43*X[1]*X[2]//25000 - 271*X[1]*X[3]//1000000 - 389*X[1]//500000 + 3*X[2]^2//500 - 3*X[2]*X[3]//10000 - 41*X[2]//100000 + X[3]^2//200 + 3*X[3]//12500 + 3//1000
M3 = [1, X[3], X[2], X[1]]
Q3 = [0.0034440021598089727 0.00013761199409195374 -0.0002378593639620438 -0.00044696298331951964;
 0.00013761199409195374 0.005140298171115548 -0.00015238090314293566 -0.00014093700607402526;
 -0.0002378593639620438 -0.00015238090314293566 0.005922008557621485 0.0008555586505019776;
 -0.00044696298331951964 -0.00014093700607402526 0.0008555586505019776 0.005646968413497785;
]
solve(n, X, P3, Q3, M3, true)
# Lie
## Multiplier-3
P4 = 77*X[1]^2//12500 - 801*X[1]*X[2]//10000000 - 129*X[1]*X[3]//100000 + 319*X[1]//100000 + 243*X[2]^2//100000 - 247*X[2]*X[3]//500000 + 27*X[2]//10000 + 159*X[3]^2//250000 + 451*X[3]//100000 + 7//500
M4 = [1, X[3], X[2], X[1]]
Q4 = [0.013702022418899805 0.0022017973210727904 0.001330187502368866 0.001558929585034504;
 0.0022017973210727904 0.0006274039533622059 -0.0002533959322305675 -0.0006539515498438223;
 0.001330187502368866 -0.0002533959322305675 0.0025526601225469665 -0.0001881073355204295;
 0.001558929585034504 -0.0006539515498438223 -0.0001881073355204295 0.006352904406166383;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-2
P5 = 57*X[1]^2//20000 - 27*X[1]*X[2]//10000 - 217*X[1]*X[3]//1000000 + 633*X[1]//1000000 + 19*X[2]^2//6250 - 331*X[2]*X[3]//500000 + 407*X[2]//1000000 + 161*X[3]^2//1000000 + 131*X[3]//250000 + 1//500
M5 = [1, X[3], X[2], X[1]]
Q5 = [0.002066546364427099 0.000268737983924883 0.0002078906920321808 0.00032369382554756884;
 0.000268737983924883 0.00018544899429393061 -0.00039659601585283763 -0.00013518734097844607;
 0.0002078906920321808 -0.00039659601585283763 0.0029548422909673722 -0.0010291272061179358;
 0.00032369382554756884 -0.00013518734097844607 -0.0010291272061179358 0.0026745403332247212;
]
solve(n, X, P5, Q5, M5, true)
## Total Decomposition
P6 = 527*X[1]^4//125000 - 28*X[1]^3*X[2]//15625 - 9079*X[1]^3*X[3]//10000000 + 519*X[1]^3//50000 + 467*X[1]^2*X[2]^2//125000 - 1281*X[1]^2*X[2]*X[3]//10000000 - 161*X[1]^2*X[2]//6250 + 3467*X[1]^2*X[3]^2//500000 - 73*X[1]^2*X[3]//500 + 291*X[1]^2//200 - 237*X[1]*X[2]^3//100000 - 3721*X[1]*X[2]^2*X[3]//10000000 - 779*X[1]*X[2]^2//20000 - 9799*X[1]*X[2]*X[3]^2//10000000 - 21*X[1]*X[2]*X[3]//200 + 4733*X[1]*X[2]//10000 - 1081*X[1]*X[3]^3//1000000 + 153*X[1]*X[3]^2//3125 - 591*X[1]*X[3]//1250 + 3163*X[1]//5000 + 327*X[2]^4//100000 - 1003*X[2]^3*X[3]//1000000 + 277*X[2]^3//250000 + 1561*X[2]^2*X[3]^2//500000 - 347*X[2]^2*X[3]//25000 + 2593*X[2]^2//5000 - 641*X[2]*X[3]^3//2500000 + 441*X[2]*X[3]^2//25000 - 2453*X[2]*X[3]//10000 + 621*X[2]//2000 + 937*X[3]^4//2500000 - 6543*X[3]^3//1000000 + 5373*X[3]^2//100000 + 817*X[3]//5000 + 23//20
M6 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q6 = [1.1495935378637576 0.08137708183752737 0.1556798925890844 0.3161016973614797 -0.01207580499751656 -0.00935945482903517 -0.02174369974847528 0.004161019246334346 -0.009840415592112042 0.006052592915440045;
 0.08137708183752737 0.07884047300954955 -0.11325000906278274 -0.21438911555128576 -0.003206960644901075 0.004642062217281655 0.013623004096923328 0.0014710655957349908 -0.00029840985628991427 -0.0005190907008283638;
 0.1556798925890844 -0.11325000906278274 0.5097069821529399 0.2468513125425387 0.00426604249037793 -0.008679057533551264 -0.027610518886386968 0.0005573718207994029 -0.009432855285803022 -0.003901686425428943;
 0.3161016973614797 -0.21438911555128576 0.2468513125425387 1.4445834757697138 0.01081261857144391 -0.025152248364701153 -0.07270992903068349 -0.009978647478524153 -0.008520142026527707 0.005227793240112084;
 -0.01207580499751656 -0.003206960644901075 0.00426604249037793 0.01081261857144391 0.0006274039224268821 -0.00025339594333774164 -0.0006539515407855728 -0.000255264164368021 -8.526126737031542e-05 -0.0004307954298775806;
 -0.00935945482903517 0.004642062217281655 -0.008679057533551264 -0.025152248364701153 -0.00025339594333774164 0.0032486359954938845 -0.00010284606668756678 -0.00039659599763420134 -0.0006355392110531864 7.962229147739642e-05;
 -0.02174369974847528 0.013623004096923328 -0.027610518886386968 -0.07270992903068349 -0.0006539515407855728 -0.00010284606668756678 0.007386612083939632 0.00050035187867426 -0.00023944321557948378 -0.0003609189497717257;
 0.004161019246334346 0.0014710655957349908 0.0005573718207994029 -0.009978647478524153 -0.000255264164368021 -0.00039659599763420134 0.00050035187867426 0.002954842300493002 -0.0010291272059146587 -0.0014681289827496303;
 -0.009840415592112042 -0.00029840985628991427 -0.009432855285803022 -0.008520142026527707 -8.526126737031542e-05 -0.0006355392110531864 -0.00023944321557948378 -0.0010291272059146587 0.007098855409792784 -0.0009929881806034486;
 0.006052592915440045 -0.0005190907008283638 -0.003901686425428943 0.005227793240112084 -0.0004307954298775806 7.962229147739642e-05 -0.0003609189497717257 -0.0014681289827496303 -0.0009929881806034486 0.004601840814503358;
]
solve(n, X, P6, Q6, M6, true)
## Multiplier-1
P7 = 17*X[1]^2//4000 - 57*X[1]*X[2]//20000 - 89*X[1]*X[3]//200000 + 67*X[1]//50000 + 21*X[2]^2//12500 - 9*X[2]*X[3]//40000 - 13*X[2]//250000 + 131*X[3]^2//1000000 + 133*X[3]//250000 + 1//500
M7 = [1, X[3], X[2], X[1]]
Q7 = [0.0019567428652690908 0.00025806906980465895 -2.470280709647104e-05 0.0006522093457472806;
 0.00025806906980465895 0.00017211842825083705 -0.0001598209278035655 -0.0003609189359073414;
 -2.470280709647104e-05 -0.0001598209278035655 0.001488058646020568 -0.0009929881786757211;
 0.0006522093457472806 -0.0003609189359073414 -0.0009929881786757211 0.004601840814829726;
]
solve(n, X, P7, Q7, M7, true)

@show SOS_time Newton_time
