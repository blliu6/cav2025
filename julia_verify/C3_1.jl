include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50


SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end

n = 2
@Symbolics.variables X[1:n]

# C3\init
## Multiplier-1
P0 = 109*X[1]^2//20 - 1041*X[1]*X[2]//5000 + 1131*X[1]//500 + 639*X[2]^2//125 + 1343*X[2]//500 + 1323//200
M0 = [1, X[2], X[1]]
Q0 = [6.614961364514536 1.3410903898342736 1.1289992605890082;
 1.3410903898342736 5.1113783774871395 -0.10401669407500193;
 1.1289992605890082 -0.10401669407500193 5.449204619477855;
]
solve(n, X, P0, Q0, M0, false)
## Multiplier-2
P1 = 1507*X[1]^2//500 - 1293*X[1]*X[2]//2000 - 131*X[1]//100 + 447*X[2]^2//200 + 963*X[2]//2500 + 4817//500
M1 = [1, X[2], X[1]]
Q1 = [9.634381976776773 0.18846564784245487 -0.6597835178722676;
 0.18846564784245487 2.235091298372464 -0.3232654849840331;
 -0.6597835178722676 -0.3232654849840331 3.014205278329948;
]
solve(n, X, P1, Q1, M1, false)
## Total Decomposition
P2 = 13623*X[1]^4//2500 - 10251*X[1]^3*X[2]//50000 - 1999*X[1]^3//625 + 81239*X[1]^2*X[2]^2//10000 - 61519*X[1]^2*X[2]//10000 + 17639*X[1]^2//1000 - 32197*X[1]*X[2]^3//50000 - 22523*X[1]*X[2]^2//5000 + 2881*X[1]*X[2]//500 + 569*X[1]//200 + 22353*X[2]^4//10000 - 6327*X[2]^3//1000 + 167*X[2]^2//25 - 4631*X[2]//1000 + 3079//1000
M2 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q2 = [3.079363543516676 -2.3154921315336345 1.4235658722865034 0.07803655577554858 0.5487427425527943 0.6368447694117085;
 -2.3154921315336345 6.526583012892151 2.33316243909634 -3.164171298343331 -0.172470230598961 -1.4809681225819011;
 1.4235658722865034 2.33316243909634 16.36675133250814 -2.073206020607339 -1.5952327096314889 -1.595603048692504;
 0.07803655577554858 -3.164171298343331 -2.073206020607339 2.235091298372559 -0.32326548498403046 0.6494370516540627;
 0.5487427425527943 -0.172470230598961 -1.5952327096314889 -0.32326548498403046 6.826709551594004 -0.10401669407500716;
 0.6368447694117085 -1.4809681225819011 -1.595603048692504 0.6494370516540627 -0.10401669407500716 5.449204619477967;
]
solve(n, X, P2, Q2, M2, false)
# C3\Lie
## Multiplier-1
P3 = 7627*X[1]^2//1000 + 273*X[1]*X[2]//20 - 157*X[1]//10 + 3687*X[2]^2//500 - 1677*X[2]//100 + 2457//250
M3 = [1, X[2], X[1]]
Q3 = [9.827660488127435 -8.380536889025366 -7.8507941067632006;
 -8.380536889025366 7.369917173323661 6.823937691154108;
 -7.8507941067632006 6.823937691154108 7.6254382789810915;
]
solve(n, X, P3, Q3, M3, false)
## Multiplier-2
P4 = 577*X[1]^2//200 + 549*X[1]*X[2]//100 - 2901*X[1]//500 + 3633*X[2]^2//1000 - 7579*X[2]//1000 + 1089//250
M4 = [1, X[2], X[1]]
Q4 = [4.355517179708814 -3.788697851664539 -2.9014812399867775;
 -3.788697851664539 3.631542182528088 2.744756583090643;
 -2.9014812399867775 2.744756583090643 2.885457843308725;
]
solve(n, X, P4, Q4, M4, false)
## Total Decomposition
P5 = 38161*X[1]^4//5000 + 2731*X[1]^3*X[2]//200 + 15207*X[1]^3//2000 + 10257*X[1]^2*X[2]^2//1000 + 76121*X[1]^2*X[2]//10000 - 16889*X[1]^2//10000 + 54927*X[1]*X[2]^3//10000 - 13177*X[1]*X[2]^2//10000 + 7273*X[1]*X[2]//1000 - 14239*X[1]//1000 + 36339*X[2]^4//10000 - 2333*X[2]^3//500 + 3156*X[2]^2//625 - 13673*X[2]//1000 + 2177//200
M5 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q5 = [10.8853274227057 -6.832015224534151 -7.120662826925925 -1.794847371535639 -2.9386952616711346 -4.762598542218598;
 -6.832015224534151 8.63593127322013 6.571592381413611 -2.3337586320437045 -0.21195217798903815 3.2667045840220044;
 -7.120662826925925 6.571592381413611 7.845975625410454 -0.44605831627570397 0.5348356021680708 3.799749122577212;
 -1.794847371535639 -2.3337586320437045 -0.44605831627570397 3.631542182527945 2.7447565830905836 0.7720669812920598;
 -2.9386952616711346 -0.21195217798903815 0.5348356021680708 2.7447565830905836 8.71124105404889 6.823937691154493;
 -4.762598542218598 3.2667045840220044 3.799749122577212 0.7720669812920598 6.823937691154493 7.625438278981038;
]
solve(n, X, P5, Q5, M5, false)
# C3\unsafe
## Multiplier-1
P6 = 2923*X[1]^2//1000 + 209*X[1]*X[2]//200 - 207*X[1]//1250 + 1653*X[2]^2//500 + 1193*X[2]//1000 + 2071//500
M6 = [1, X[2], X[1]]
Q6 = [4.142455835311122 0.5964131055521663 -0.08193220247261152;
 0.5964131055521663 3.3056990531025647 0.5223884681788696;
 -0.08193220247261152 0.5223884681788696 2.923115102393328;
]
solve(n, X, P6, Q6, M6, false)
## Multiplier-2
P7 = 2243*X[1]^2//1000 + 1923*X[1]*X[2]//5000 + 113*X[1]//100 + 2427*X[2]^2//500 - 1017*X[2]//1000 + 4311//1000
M7 = [1, X[2], X[1]]
Q7 = [4.311299970919905 -0.5088533609333393 0.5658508352112168;
 -0.5088533609333393 4.854165632864661 0.1920390710032523;
 0.5658508352112168 0.1920390710032523 2.242983684904215;
]
solve(n, X, P7, Q7, M7, false)
## Total Decomposition
P8 = 5847*X[1]^4//2000 + 2089*X[1]^3*X[2]//2000 + 35729*X[1]^3//5000 + 55511*X[1]^2*X[2]^2//10000 + 9521*X[1]^2*X[2]//2500 - 4647*X[1]^2//2500 + 38529*X[1]*X[2]^3//100000 + 46953*X[1]*X[2]^2//5000 - 3909*X[1]*X[2]//2000 - 6361*X[1]//2500 + 6071*X[2]^4//1250 - 10147*X[2]^3//10000 + 2789*X[2]^2//250 - 21741*X[2]//1000 + 17907//1000
M8 = [1, X[2], X[1], X[2]^2, X[1]*X[2], X[1]^2]
Q8 = [17.906750011880984 -10.876506415929901 -1.2727670942912113 -0.5299627744178296 -1.656218572403744 -4.406308224134817;
 -10.876506415929901 12.237570964415639 0.671441839082695 -0.508853360933343 3.241199656271881 2.561032370061162;
 -1.2727670942912113 0.671441839082695 6.951780577036624 1.4567749942200037 -0.6586480940619444 3.5719616744213014;
 -0.5299627744178296 -0.508853360933343 1.4567749942200037 4.854165632864643 0.19203907100324813 0.659982821840046;
 -1.656218572403744 3.241199656271881 -0.6586480940619444 0.19203907100324813 4.228717093448623 0.5223884681788714;
 -4.406308224134817 2.561032370061162 3.5719616744213014 0.659982821840046 0.5223884681788714 2.9231151023935777;
]
solve(n, X, P8, Q8, M8, false)

@show SOS_time Newton_time

