include("utils/util.jl")
include("utils/newtonUpdate.jl")
include("utils/rationalSOS.jl")

X = nothing
eig_tol = 1e-4
tol = 1e-50


SOS_time = 0
Newton_time = 0
function solve(n, X, f, Q, mono,newton)
    global SOS_time, Newton_time
    Q = round.(Q, digits=2)
    rQ = symplify_rational.(Q)

    model = nothing
    if !newton
        model = rational_SOS(f, 1, 0, mono, rQ)
    else
        Newton_time+=@elapsed update_Q = newton_refine_update(f, mono, Q, eig_tol, 90, tol, X)
        Q_res = symplify_rational.(update_Q*update_Q')
        SOS_time+=@elapsed model = rational_SOS(f, 1, 0, mono, Q_res)
    end
    
    SOSrational_time, coeffs, terms = model[2:end]
    
    @show expand(f-(coeffs' * terms.^2))

    data = Dict(
        "n" => n,
        "expression" => f,
        "coeff" => join([string(c) for c in coeffs], ","),
        "term" => join([string(t) for t in terms], ","),
        "SOSrational_time" => SOSrational_time,
        "SOS_expression" => string(coeffs' * terms.^2)
    )

    # save("src/output/data.json", data)    
end


n = 3
@Symbolics.variables X[1:n]
#C8
# init
## Total Decomposition
P0 = 3939*X[1]^4//1000 + 49*X[1]^3*X[2]//400 - 1233*X[1]^3*X[3]//10000 + 78*X[1]^3//625 + 1969*X[1]^2*X[2]^2//250 + 3*X[1]^2*X[2]*X[3]//125 - 1879*X[1]^2*X[2]//10000 + 789*X[1]^2*X[3]^2//100 - 1039*X[1]^2*X[3]//200000 - 3059*X[1]^2//1000 + 29*X[1]*X[2]^3//250 - 1233*X[1]*X[2]^2*X[3]//10000 + 637*X[1]*X[2]^2//5000 + 607*X[1]*X[2]*X[3]^2//5000 + 321*X[1]*X[2]*X[3]//250000 - 567*X[1]*X[2]//125 - 1279*X[1]*X[3]^3//10000 + 1269*X[1]*X[3]^2//10000 + 1239*X[1]*X[3]//200 + 709*X[1]//500 + 492*X[2]^4//125 + 341*X[2]^3*X[3]//25000 - 943*X[2]^3//5000 + 1577*X[2]^2*X[3]^2//200 - 87*X[2]^2*X[3]//15625 + 1229*X[2]^2//1000 + 991*X[2]*X[3]^3//50000 - 1819*X[2]*X[3]^2//10000 + 5833*X[2]*X[3]//1000 - 873*X[2]//500 + 3949*X[3]^4//1000 - 5031*X[3]^3//1000000 + 1187*X[3]^2//10000 - 709*X[3]//5000 + 1091//200
M0 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q0 = [5.455457451093913 -0.0730016445483599 -0.8720059457321598 0.7087411159805759 -1.6247511217414154 1.7311961414524233 2.0431996889339454 -1.3094210395645123 -1.454657550059228 -2.6470094861594236;
 -0.0730016445483599 3.3703142164699225 1.186116429429218 1.0533599618064713 -0.0014674661453880143 -0.198900895445224 0.1405618824189407 0.09290357155033936 0.022213505764629094 -0.07162361805271318;
 -0.8720059457321598 1.186116429429218 3.8453520257539235 -0.8125266618444036 0.10562433125443145 -0.09437103769572897 -0.26860609635746635 -0.09327656419079222 0.19024371127302167 0.25714906019741507;
 0.7087411159805759 1.0533599618064713 -0.8125266618444036 2.2348462520713577 -0.07818425217396341 0.24639259059283758 0.07015615190733197 -0.12786608102803435 -0.3504256243882058 0.062377630244981774;
 -1.6247511217414154 -0.0014674661453880143 0.10562433125443145 -0.07818425217396341 3.947987790504601 0.008613151681095312 -0.06121268640257836 0.7634508088416924 -0.023783472916573754 0.9543364808222219;
 1.7311961414524233 -0.198900895445224 -0.09437103769572897 0.24639259059283758 0.008613151681095312 6.356881925814496 0.08317690832078078 0.008613151681094527 0.000684653617887391 -0.3733171399249238;
 2.0431996889339454 0.1405618824189407 -0.26860609635746635 0.07015615190733197 -0.06121268640257836 0.08317690832078078 5.979380982473179 -0.061897340020457894 0.38193029160602177 -0.06121268640257278;
 -1.3094210395645123 0.09290357155033936 -0.09327656419079222 -0.12786608102803435 0.7634508088416924 0.008613151681094527 -0.061897340020457894 3.9357957563751698 0.05939343540420707 0.9310576032928495;
 -1.454657550059228 0.022213505764629094 0.19024371127302167 -0.3504256243882058 -0.023783472916573754 0.000684653617887391 0.38193029160602177 0.05939343540420707 6.0137467034025205 0.059393435404208404;
 -2.6470094861594236 -0.07162361805271318 0.25714906019741507 0.062377630244981774 0.9543364808222219 -0.3733171399249238 -0.06121268640257278 0.9310576032928495 0.059393435404208404 3.940066156994927;
]
solve(n, X, P0, Q0, M0, true)
## Multiplier-1
P1 = 19701*X[1]^2//5000 + 11671*X[1]*X[2]//100000 - 1263*X[1]*X[3]//10000 + 1501*X[1]//12500 + 39359*X[2]^2//10000 + 159*X[2]*X[3]//10000 - 3627*X[2]//20000 + 987*X[3]^2//250 + 5019//500
M1 = [1, X[3], X[2], X[1]]
Q1 = [10.038401337456964 -0.001467466145387627 -0.09327656419079414 0.06237763024498588;
 -0.001467466145387627 3.947987790504602 0.008613151681093906 -0.0612126864025789;
 -0.09327656419079414 0.008613151681093906 3.935795756375173 0.0593934354042091;
 0.06237763024498588 -0.0612126864025789 0.0593934354042091 3.9400661569949174;
]
solve(n, X, P1, Q1, M1, true)
# unsafe
## Total Decomposition
P2 = 19019*X[1]^4//10000 - 539*X[1]^3*X[2]//25000 + 79937*X[1]^3*X[3]//1000000 - 10339*X[1]^3//2500 + 18973*X[1]^2*X[2]^2//5000 + 36043*X[1]^2*X[2]*X[3]//1000000 - 44429*X[1]^2*X[2]//10000 + 37713*X[1]^2*X[3]^2//10000 - 47623*X[1]^2*X[3]//10000 + 20017*X[1]^2//1000 - 1453*X[1]*X[2]^3//62500 + 41957*X[1]*X[2]^2*X[3]//500000 - 40287*X[1]*X[2]^2//10000 - 4471*X[1]*X[2]*X[3]^2//250000 - 847*X[1]*X[2]*X[3]//3125 - 5053*X[1]*X[2]//1250 + 9903*X[1]*X[3]^3//125000 - 4259*X[1]*X[3]^2//1000 - 13821*X[1]*X[3]//1000 - 1033*X[1]//1000 + 949*X[2]^4//500 + 19459*X[2]^3*X[3]//500000 - 2818*X[2]^3//625 + 37621*X[2]^2*X[3]^2//10000 - 46273*X[2]^2*X[3]//10000 + 3379*X[2]^2//200 + 14897*X[2]*X[3]^3//500000 - 22401*X[2]*X[3]^2//5000 - 12729*X[2]*X[3]//1000 - 1249*X[2]//10000 + 18657*X[3]^4//10000 - 44309*X[3]^3//10000 + 8917*X[3]^2//500 - 201*X[3]//100 + 2839//500
M2 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q2 = [5.678232448309796 -1.0050871653431115 -0.06300269403564618 -0.5193313168579208 0.35488705691934247 -1.4402835968521492 -1.2354847637731712 0.47901102928499156 -0.9473974686441894 0.7616325259040089;
 -1.0050871653431115 17.130313919398947 -4.920736291209267 -5.678019838261172 -2.2128964839280196 -2.0571670855724347 -1.8777426058443087 0.023756492140866566 0.2394305668593809 -0.0207544732131041;
 -0.06300269403564618 -4.920736291209267 15.941340490734897 -1.0756115694449533 -0.19495871357835326 -2.3299488259217953 -0.22147602143731468 -2.251187303120654 -1.898629572987317 -0.06932703136071072;
 -0.5193313168579208 -5.678019838261172 -1.0756115694449533 18.50191830389384 -0.24563627982705866 -0.14384450047904257 -2.359628462466967 -0.11909170146436664 -2.1513317584675677 -2.06025626717616;
 0.35488705691934247 -2.2128964839280196 -0.19495871357835326 -0.24563627982705866 1.8656554574841333 0.015705726186154418 0.03843484962264851 -0.15578281765618376 -0.13305382358022627 -0.14689439483063627;
 -1.4402835968521492 -2.0571670855724347 -2.3299488259217953 -0.14384450047904257 0.015705726186154418 4.073662338558071 0.12087657112577767 0.015705726186393244 0.07405158831271876 -0.1093618217740001;
 -1.2354847637731712 -1.8777426058443087 -0.22147602143731468 -2.359628462466967 0.03843484962264851 0.12087657112577767 4.059887653194688 -0.035616738690084145 0.1250675479601859 0.03843484962269473;
 0.47901102928499156 0.023756492140866566 -2.251187303120654 -0.11909170146436664 -0.15578281765618376 0.015705726186393244 -0.035616738690084145 1.8964412457616346 -0.012177252454484325 -0.0911445087009415;
 -0.9473974686441894 0.2394305668593809 -1.898629572987317 -2.1513317584675677 -0.13305382358022627 0.07405158831271876 0.1250675479601859 -0.012177252454484325 3.979173669212899 -0.012177252454422033;
 0.7616325259040089 -0.0207544732131041 -0.06932703136071072 -2.06025626717616 -0.14689439483063627 -0.1093618217740001 0.03843484962269473 -0.0911445087009415 -0.012177252454422033 1.9004434060494462;
]
solve(n, X, P2, Q2, M2, true)
## Multiplier-1
P3 = 1901*X[1]^2//1000 - 1279*X[1]*X[2]//50000 + 1929*X[1]*X[3]//25000 + 1583*X[1]//1000 + 1897*X[2]^2//1000 + 759*X[2]*X[3]//25000 + 593*X[2]//500 + 933*X[3]^2//500 + 293*X[3]//250 + 3257//1000
M3 = [1, X[3], X[2], X[1]]
Q3 = [3.2572448126917593 0.5855862988845401 0.5934741556637603 0.7904084078482105;
 0.5855862988845401 1.8656552350807774 0.015705724314151702 0.038434845041224346;
 0.5934741556637603 0.015705724314151702 1.8964410196884667 -0.012177251002778494;
 0.7904084078482105 0.038434845041224346 -0.012177251002778494 1.9004431794991745;
]
solve(n, X, P3, Q3, M3, true)
# Lie
## Multiplier-3
P4 = 148*X[1]^2//125 + 2077*X[1]*X[2]//10000 - 1001*X[1]*X[3]//500 + 73*X[1]//200 + 2389*X[2]^2//10000 - 173*X[2]*X[3]//125 + 801*X[2]//10000 + 1617*X[3]^2//500 + 38*X[3]//125 + 77//200
M4 = [1, X[3], X[2], X[1]]
Q4 = [0.38475097344308007 0.15180548068141372 0.040099009330208775 0.1825088966806648;
 0.15180548068141372 3.2341235436741256 -0.6919221352780013 -1.0019129578647492;
 0.040099009330208775 -0.6919221352780013 0.23888660076678409 0.10415952089360439;
 0.1825088966806648 -1.0019129578647492 0.10415952089360439 1.184583632704171;
]
solve(n, X, P4, Q4, M4, true)
## Multiplier-2
P5 = 809*X[1]^2//500 - 1479*X[1]*X[2]//50000 - 1471*X[1]*X[3]//1000 + 1469*X[1]//50000 + 4947*X[2]^2//10000 - 142*X[2]*X[3]//125 + 3381*X[2]//10000 + 3229*X[3]^2//1000 + 7253*X[3]//10000 + 49//40
M5 = [1, X[3], X[2], X[1]]
Q5 = [1.2252638468166404 0.3624709955628157 0.16899999723569142 0.015207581097799168;
 0.3624709955628157 3.2289579128396446 -0.5673835724601396 -0.7367208246825181;
 0.16899999723569142 -0.5673835724601396 0.49414180621408904 -0.014474784658108805;
 0.015207581097799168 -0.7367208246825181 -0.014474784658108805 1.6181560734296005;
]
solve(n, X, P5, Q5, M5, true)
## Total Decomposition
P6 = 1619*X[1]^4//1000 + 141*X[1]^3*X[2]//1250 - 2099*X[1]^3*X[3]//1000 - 8931*X[1]^3//100000 + 1887*X[1]^2*X[2]^2//1000 - 182*X[1]^2*X[2]*X[3]//125 - 787*X[1]^2*X[2]//5000 + 561*X[1]^2*X[3]^2//125 + 168*X[1]^2*X[3]//125 + 903*X[1]^2//250 - 1473*X[1]*X[2]^3//50000 - 1477*X[1]*X[2]^2*X[3]//1000 - 2819*X[1]*X[2]^2//10000 + 1039*X[1]*X[2]*X[3]^2//5000 + 167*X[1]*X[2]*X[3]//20 + 2809*X[1]*X[2]//10000 - 1003*X[1]*X[3]^3//500 - 432*X[1]*X[3]^2//125 - 263*X[1]*X[3]//125 - 1283*X[1]//1000 + 4929*X[2]^4//10000 - 1133*X[2]^3*X[3]//1000 + 1763*X[2]^3//5000 + 3469*X[2]^2*X[3]^2//1000 - 313*X[2]^2*X[3]//250 - 93*X[2]^2//100 - 1381*X[2]*X[3]^3//1000 + 2447*X[2]*X[3]^2//1000 - 357*X[2]*X[3]//100 - 4047*X[2]//50000 + 647*X[3]^4//200 - 262*X[3]^3//125 + 707*X[3]^2//100 + 3861*X[3]//10000 + 3113//1000
M6 = [1, X[3], X[2], X[1], X[3]^2, X[2]*X[3], X[1]*X[3], X[2]^2, X[1]*X[2], X[1]^2]
Q6 = [3.112992150058558 0.1916842415546726 -0.04001476390897683 -0.6397486673863191 0.9637837455876066 -0.7318778977008862 -0.867579753552654 -0.8139544450997561 0.24517344745571193 0.34068055370254274;
 0.1916842415546726 5.140143032112692 -1.0550995457842047 -0.18401446665997387 -1.0478605548160973 0.8120756003001187 -1.1484985418426943 -0.26022785501091333 1.7201073951183965 0.23068228102789848;
 -0.04001476390897683 -1.0550995457842047 0.6959653207744366 -0.10560096791215642 0.41298691675825266 -0.36599758221124645 0.522047500988009 0.17631939317017453 -0.07988775028986846 -0.022699639869692912;
 -0.6397486673863191 -0.18401446665997387 -0.10560096791215642 2.9329566267355234 -0.5767330719538764 1.9352780420168785 0.43968246622521406 -0.06310821818390107 -0.056521602830089605 -0.04399048700598026;
 0.9637837455876066 -1.0478605548160973 0.41298691675825266 -0.5767330719538764 3.234123543673927 -0.6919221352779659 -1.0019129578647479 -0.2909318362910886 -0.3927911605235087 0.4210046165346101;
 -0.7318778977008862 0.8120756003001187 -0.36599758221124645 1.9352780420168785 -0.6919221352779659 4.049708186188356 0.49695068141710624 -0.5673835724600216 -0.9248308564265955 -0.126859659138288;
 -0.867579753552654 -1.1484985418426943 0.522047500988009 0.43968246622521406 -1.0019129578647479 0.49695068141710624 3.646495103607299 0.18811003174413324 -0.6013253634320486 -1.0495821420410976;
 -0.8139544450997561 -0.26022785501091333 0.17631939317017453 -0.06310821818390107 -0.2909318362910886 -0.5673835724600216 0.18811003174413324 0.49414180621460074 -0.014474784658087731 -0.09751509261946213;
 0.24517344745571193 1.7201073951183965 -0.07988775028986846 -0.056521602830089605 -0.3927911605235087 -0.9248308564265955 -0.6013253634320486 -0.014474784658087731 2.081694511320207 0.056387816362939956;
 0.34068055370254274 0.23068228102789848 -0.022699639869692912 -0.04399048700598026 0.4210046165346101 -0.126859659138288 -1.0495821420410976 -0.09751509261946213 0.056387816362939956 1.6202810410834758;
]
solve(n, X, P6, Q6, M6, true)
## Multiplier-1
P7 = 811*X[1]^2//500 + 1133*X[1]*X[2]//10000 - 1051*X[1]*X[3]//500 + 531*X[1]//1000 + 1339*X[2]^2//5000 - 727*X[2]*X[3]//500 + 113*X[2]//1000 + 413*X[3]^2//125 + 39*X[3]//200 + 387//1000
M7 = [1, X[3], X[2], X[1]]
Q7 = [0.38687111504052546 0.09767569891396047 0.056297077921952286 0.26557017570036434;
 0.09767569891396047 3.3039207039725444 -0.7281850225704024 -1.0495821420410232;
 0.056297077921952286 -0.7281850225704024 0.2685082526515057 0.056387816362803884;
 0.26557017570036434 -1.0495821420410232 0.056387816362803884 1.6202810410834618;
]
solve(n, X, P7, Q7, M7, true)

@show SOS_time Newton_time